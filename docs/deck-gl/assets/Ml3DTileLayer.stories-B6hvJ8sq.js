import{j as Tt}from"./index-17y-JmIx.js";import{L as xi,S as Fn,V as Ni,i as Pi,c as Xe,a as Be,t as Ri,v as Oi,b as Di,d as Ui,e as Vi,f as Gn,p as kn,g as Hn,U as Bi,M as It,G as Ne,h as d,j as qi,k as ie,l as Ee,T as zi,m as jn,n as Fi,o as Gi,q as ki,r as Hi,s as I,u as N,w as K,x as Pe,y as Wn,z as ji,A as Wi,B as Zi,C as it,D as $i,E as Yi,F as Xi}from"./useDeckGl-BLLSfejp.js";import{r as kt}from"./iframe-r0EXsZSX.js";import{l as Qi,M as O,Q as Qe,g as Ki,a as Ji,s as es,p as ts,b as ns,c as At,D as is,G as Zn,d as $n,e as Yn,S as ss}from"./scenegraph-layer-ByHOGDli.js";import{g as rs,C as os}from"./gouraud-material-DzCldn4z.js";import"./index-DJSjLiaV.js";import"./preload-helper-D9Z9MdNV.js";globalThis.probe={};const Xn=new xi({id:"@probe.gl/log"}),as="Queued Requests",cs="Active Requests",ls="Cancelled Requests",us="Queued Requests Ever",hs="Active Requests Ever",ds={id:"request-scheduler",throttleRequests:!0,maxRequests:6,debounceTime:0};class fs{props;stats;activeRequestCount=0;requestQueue=[];requestMap=new Map;updateTimer=null;constructor(e={}){this.props={...ds,...e},this.stats=new Fn({id:this.props.id}),this.stats.get(as),this.stats.get(cs),this.stats.get(ls),this.stats.get(us),this.stats.get(hs)}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);const i={handle:e,priority:0,getPriority:t},s=new Promise(r=>(i.resolve=r,i));return this.requestQueue.push(i),this.requestMap.set(e,s),this._issueNewRequests(),s}_issueRequest(e){const{handle:t,resolve:i}=e;let s=!1;const r=()=>{s||(s=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:r}):Promise.resolve({done:r})}_issueNewRequests(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this._issueNewRequestsAsync(),this.props.debounceTime)}_issueNewRequestsAsync(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=null;const e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let t=0;t<e;++t){const i=this.requestQueue.shift();i&&this._issueRequest(i)}}}_updateAllRequests(){const e=this.requestQueue;for(let t=0;t<e.length;++t){const i=e[t];this._updateRequest(i)||(e.splice(t,1),this.requestMap.delete(i.handle),t--)}e.sort((t,i)=>t.priority-i.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}}class xt extends Ni{constructor(e=0,t=0){super(2),Pi(e)&&arguments.length===1?this.copy(e):(Xe.debug&&(Be(e),Be(t)),this[0]=e,this[1]=t)}set(e,t){return this[0]=e,this[1]=t,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this.check()}fromObject(e){return Xe.debug&&(Be(e.x),Be(e.y)),this[0]=e.x,this[1]=e.y,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Ri(this,this,e),this.check()}transformAsVector(e){return Oi(this,this,e),this.check()}transformByMatrix3(e){return Di(this,this,e),this.check()}transformByMatrix2x3(e){return Ui(this,this,e),this.check()}transformByMatrix2(e){return Vi(this,this,e),this.check()}}const ps=.1,ms=1e-12,Qn=1e-15,gs=1e-20,ys=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,Ts=`#define MAX_LIGHTS 3

uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,_s=`struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`,Kn={name:"phongMaterial",dependencies:[Qi],source:_s,vs:ys,fs:Ts,defines:{LIGHTING_FRAGMENT:!0},uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(n){const e={...n};return e.specularColor&&(e.specularColor=e.specularColor.map(t=>t/255)),{...Kn.defaultUniforms,...e}}},Ht=`uniform pointCloudUniforms {
  float radiusPixels;
  highp int sizeUnits;
} pointCloud;
`,ws={name:"pointCloud",vs:Ht,fs:Ht,uniformTypes:{radiusPixels:"f32",sizeUnits:"i32"}},Cs=`#version 300 es
#define SHADER_NAME point-cloud-layer-vertex-shader
in vec3 positions;
in vec3 instanceNormals;
in vec4 instanceColors;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec3 instancePickingColors;
out vec4 vColor;
out vec2 unitPosition;
void main(void) {
geometry.worldPosition = instancePositions;
geometry.normal = project_normal(instanceNormals);
unitPosition = positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
vec3 offset = vec3(positions.xy * project_size_to_pixel(pointCloud.radiusPixels, pointCloud.sizeUnits), 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
vec3 lightColor = lighting_getLightColor(instanceColors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, instanceColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Es=`#version 300 es
#define SHADER_NAME point-cloud-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 unitPosition;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition.xy;
float distToCenter = length(unitPosition);
if (distToCenter > 1.0) {
discard;
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Jn=[0,0,0,255],ei=[0,0,1],bs={sizeUnits:"pixels",pointSize:{type:"number",min:0,value:10},getPosition:{type:"accessor",value:n=>n.position},getNormal:{type:"accessor",value:ei},getColor:{type:"accessor",value:Jn},material:!0,radiusPixels:{deprecatedFor:"pointSize"}};function Ss(n){const{header:e,attributes:t}=n;if(!(!e||!t)&&(n.length=e.vertexCount,t.POSITION&&(t.instancePositions=t.POSITION),t.NORMAL&&(t.instanceNormals=t.NORMAL),t.COLOR_0)){const{size:i,value:s}=t.COLOR_0;t.instanceColors={size:i,type:"unorm8",value:s}}}class Nt extends Gn{getShaders(){return super.getShaders({vs:Cs,fs:Es,modules:[kn,rs,Hn,ws]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceNormals:{size:3,transition:!0,accessor:"getNormal",defaultValue:ei},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:Jn}})}updateState(e){const{changeFlags:t,props:i}=e;super.updateState(e),t.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll()),t.dataChanged&&Ss(i.data)}draw({uniforms:e}){const{pointSize:t,sizeUnits:i}=this.props,s=this.state.model,r={sizeUnits:Bi[i],radiusPixels:t};s.shaderInputs.setProps({pointCloud:r}),s.draw(this.context.renderPass)}_getModel(){const e=[];for(let t=0;t<3;t++){const i=t/3*Math.PI*2;e.push(Math.cos(i)*2,Math.sin(i)*2,0)}return new It(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Ne({topology:"triangle-list",attributes:{positions:new Float32Array(e)}}),isInstanced:!0})}}Nt.layerName="PointCloudLayer";Nt.defaultProps=bs;const F={OUTSIDE:-1,INTERSECTING:0,INSIDE:1};new d;new d;const ve=new d,jt=new d;class Re{constructor(e=[0,0,0],t=0){this.radius=-0,this.center=new d,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=ve.from(t),this.center=new d().from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new Re(this.center,this.radius)}union(e){const t=this.center,i=this.radius,s=e.center,r=e.radius,o=ve.copy(s).subtract(t),a=o.magnitude();if(i>=a+r)return this.clone();if(r>=a+i)return e.clone();const c=(i+a+r)*.5;return jt.copy(o).scale((-i+c)/a).add(t),this.center.copy(jt),this.radius=c,this}expand(e){const i=ve.from(e).subtract(this.center).magnitude();return i>this.radius&&(this.radius=i),this}transform(e){this.center.transform(e);const t=qi(ve,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){const t=this.distanceTo(e);return t*t}distanceTo(e){const i=ve.from(e).subtract(this.center);return Math.max(0,i.len()-this.radius)}intersectPlane(e){const t=this.center,i=this.radius,r=e.normal.dot(t)+e.distance;return r<-i?F.OUTSIDE:r<i?F.INTERSECTING:F.INSIDE}}const Ls=new d,Ms=new d,qe=new d,ze=new d,Fe=new d,vs=new d,Is=new d,ne={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8};class Oe{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){this.center=new d().from(e),this.halfAxes=new O(t)}get halfSize(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new d(e).len(),new d(t).len(),new d(i).len()]}get quaternion(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),s=new d(e).normalize(),r=new d(t).normalize(),o=new d(i).normalize();return new Qe().fromMatrix3(new O([...s,...r,...o]))}fromCenterHalfSizeQuaternion(e,t,i){const s=new Qe(i),r=new O().fromQuaternion(s);return r[0]=r[0]*t[0],r[1]=r[1]*t[0],r[2]=r[2]*t[0],r[3]=r[3]*t[1],r[4]=r[4]*t[1],r[5]=r[5]*t[1],r[6]=r[6]*t[2],r[7]=r[7]*t[2],r[8]=r[8]*t[2],this.center=new d().from(e),this.halfAxes=r,this}clone(){return new Oe(this.center,this.halfAxes)}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new Re){const t=this.halfAxes,i=t.getColumn(0,qe),s=t.getColumn(1,ze),r=t.getColumn(2,Fe),o=Ls.copy(i).add(s).add(r);return e.center.copy(this.center),e.radius=o.magnitude(),e}intersectPlane(e){const t=this.center,i=e.normal,s=this.halfAxes,r=i.x,o=i.y,a=i.z,c=Math.abs(r*s[ne.COLUMN0ROW0]+o*s[ne.COLUMN0ROW1]+a*s[ne.COLUMN0ROW2])+Math.abs(r*s[ne.COLUMN1ROW0]+o*s[ne.COLUMN1ROW1]+a*s[ne.COLUMN1ROW2])+Math.abs(r*s[ne.COLUMN2ROW0]+o*s[ne.COLUMN2ROW1]+a*s[ne.COLUMN2ROW2]),l=i.dot(t)+e.distance;return l<=-c?F.OUTSIDE:l>=c?F.INSIDE:F.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const t=Ms.from(e).subtract(this.center),i=this.halfAxes,s=i.getColumn(0,qe),r=i.getColumn(1,ze),o=i.getColumn(2,Fe),a=s.magnitude(),c=r.magnitude(),l=o.magnitude();s.normalize(),r.normalize(),o.normalize();let u=0,h;return h=Math.abs(t.dot(s))-a,h>0&&(u+=h*h),h=Math.abs(t.dot(r))-c,h>0&&(u+=h*h),h=Math.abs(t.dot(o))-l,h>0&&(u+=h*h),u}computePlaneDistances(e,t,i=[-0,-0]){let s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;const o=this.center,a=this.halfAxes,c=a.getColumn(0,qe),l=a.getColumn(1,ze),u=a.getColumn(2,Fe),h=vs.copy(c).add(l).add(u).add(o),f=Is.copy(h).subtract(e);let p=t.dot(f);return s=Math.min(p,s),r=Math.max(p,r),h.copy(o).add(c).add(l).subtract(u),f.copy(h).subtract(e),p=t.dot(f),s=Math.min(p,s),r=Math.max(p,r),h.copy(o).add(c).subtract(l).add(u),f.copy(h).subtract(e),p=t.dot(f),s=Math.min(p,s),r=Math.max(p,r),h.copy(o).add(c).subtract(l).subtract(u),f.copy(h).subtract(e),p=t.dot(f),s=Math.min(p,s),r=Math.max(p,r),o.copy(h).subtract(c).add(l).add(u),f.copy(h).subtract(e),p=t.dot(f),s=Math.min(p,s),r=Math.max(p,r),o.copy(h).subtract(c).add(l).subtract(u),f.copy(h).subtract(e),p=t.dot(f),s=Math.min(p,s),r=Math.max(p,r),o.copy(h).subtract(c).subtract(l).add(u),f.copy(h).subtract(e),p=t.dot(f),s=Math.min(p,s),r=Math.max(p,r),o.copy(h).subtract(c).subtract(l).subtract(u),f.copy(h).subtract(e),p=t.dot(f),s=Math.min(p,s),r=Math.max(p,r),i[0]=s,i[1]=r,i}transform(e){this.center.transformAsPoint(e);const t=this.halfAxes.getColumn(0,qe);t.transformAsPoint(e);const i=this.halfAxes.getColumn(1,ze);i.transformAsPoint(e);const s=this.halfAxes.getColumn(2,Fe);return s.transformAsPoint(e),this.halfAxes=new O([...t,...i,...s]),this}getTransform(){throw new Error("not implemented")}}const Wt=new d,Zt=new d;class J{constructor(e=[0,0,1],t=0){this.normal=new d,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return ie(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=Wt.from(e),this.normal.from(t).normalize();const i=-this.normal.dot(e);return this.distance=i,this}fromCoefficients(e,t,i,s){return this.normal.set(e,t,i),ie(Ee(this.normal.len(),1)),this.distance=s,this}clone(){return new J(this.normal,this.distance)}equals(e){return Ee(this.distance,e.distance)&&Ee(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){const t=Zt.copy(this.normal).transformAsVector(e).normalize(),i=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(i,t)}projectPointOntoPlane(e,t=[0,0,0]){const i=Wt.from(e),s=this.getPointDistance(i),r=Zt.copy(this.normal).scale(s);return i.subtract(r).to(t)}}const $t=[new d([1,0,0]),new d([0,1,0]),new d([0,0,1])],Yt=new d,As=new d;class H{constructor(e=[]){this.planes=e}fromBoundingSphere(e){this.planes.length=2*$t.length;const t=e.center,i=e.radius;let s=0;for(const r of $t){let o=this.planes[s],a=this.planes[s+1];o||(o=this.planes[s]=new J),a||(a=this.planes[s+1]=new J);const c=Yt.copy(r).scale(-i).add(t);o.fromPointNormal(c,r);const l=Yt.copy(r).scale(i).add(t),u=As.copy(r).negate();a.fromPointNormal(l,u),s+=2}return this}computeVisibility(e){let t=F.INSIDE;for(const i of this.planes)switch(e.intersectPlane(i)){case F.OUTSIDE:return F.OUTSIDE;case F.INTERSECTING:t=F.INTERSECTING;break}return t}computeVisibilityWithPlaneMask(e,t){if(ie(Number.isFinite(t),"parentPlaneMask is required."),t===H.MASK_OUTSIDE||t===H.MASK_INSIDE)return t;let i=H.MASK_INSIDE;const s=this.planes;for(let r=0;r<this.planes.length;++r){const o=r<31?1<<r:0;if(r<31&&(t&o)===0)continue;const a=s[r],c=e.intersectPlane(a);if(c===F.OUTSIDE)return H.MASK_OUTSIDE;c===F.INTERSECTING&&(i|=o)}return i}}H.MASK_OUTSIDE=4294967295;H.MASK_INSIDE=0;H.MASK_INDETERMINATE=2147483647;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;new d;const Q=new O,xs=new O,Ns=new O,Ge=new O,Xt=new O;function Ps(n,e={}){const t=gs,i=10;let s=0,r=0;const o=xs,a=Ns;o.identity(),a.copy(n);const c=t*Rs(a);for(;r<i&&Os(a)>c;)Ds(a,Ge),Xt.copy(Ge).transpose(),a.multiplyRight(Ge),a.multiplyLeft(Xt),o.multiplyRight(Ge),++s>2&&(++r,s=0);return e.unitary=o.toTarget(e.unitary),e.diagonal=a.toTarget(e.diagonal),e}function Rs(n){let e=0;for(let t=0;t<9;++t){const i=n[t];e+=i*i}return Math.sqrt(e)}const _t=[1,0,0],wt=[2,2,1];function Os(n){let e=0;for(let t=0;t<3;++t){const i=n[Q.getElementIndex(wt[t],_t[t])];e+=2*i*i}return Math.sqrt(e)}function Ds(n,e){const t=Qn;let i=0,s=1;for(let l=0;l<3;++l){const u=Math.abs(n[Q.getElementIndex(wt[l],_t[l])]);u>i&&(s=l,i=u)}const r=_t[s],o=wt[s];let a=1,c=0;if(Math.abs(n[Q.getElementIndex(o,r)])>t){const l=n[Q.getElementIndex(o,o)],u=n[Q.getElementIndex(r,r)],h=n[Q.getElementIndex(o,r)],f=(l-u)/2/h;let p;f<0?p=-1/(-f+Math.sqrt(1+f*f)):p=1/(f+Math.sqrt(1+f*f)),a=1/Math.sqrt(1+p*p),c=p*a}return O.IDENTITY.to(e),e[Q.getElementIndex(r,r)]=e[Q.getElementIndex(o,o)]=a,e[Q.getElementIndex(o,r)]=c,e[Q.getElementIndex(r,o)]=-c,e}const le=new d,Us=new d,Vs=new d,Bs=new d,qs=new d,zs=new O,Fs={diagonal:new O,unitary:new O};function Gs(n,e=new Oe){if(!n||n.length===0)return e.halfAxes=new O([0,0,0,0,0,0,0,0,0]),e.center=new d,e;const t=n.length,i=new d(0,0,0);for(const L of n)i.add(L);const s=1/t;i.multiplyByScalar(s);let r=0,o=0,a=0,c=0,l=0,u=0;for(const L of n){const M=le.copy(L).subtract(i);r+=M.x*M.x,o+=M.x*M.y,a+=M.x*M.z,c+=M.y*M.y,l+=M.y*M.z,u+=M.z*M.z}r*=s,o*=s,a*=s,c*=s,l*=s,u*=s;const h=zs;h[0]=r,h[1]=o,h[2]=a,h[3]=o,h[4]=c,h[5]=l,h[6]=a,h[7]=l,h[8]=u;const{unitary:f}=Ps(h,Fs),p=e.halfAxes.copy(f);let g=p.getColumn(0,Vs),y=p.getColumn(1,Bs),T=p.getColumn(2,qs),_=-Number.MAX_VALUE,b=-Number.MAX_VALUE,v=-Number.MAX_VALUE,P=Number.MAX_VALUE,R=Number.MAX_VALUE,x=Number.MAX_VALUE;for(const L of n)le.copy(L),_=Math.max(le.dot(g),_),b=Math.max(le.dot(y),b),v=Math.max(le.dot(T),v),P=Math.min(le.dot(g),P),R=Math.min(le.dot(y),R),x=Math.min(le.dot(T),x);g=g.multiplyByScalar(.5*(P+_)),y=y.multiplyByScalar(.5*(R+b)),T=T.multiplyByScalar(.5*(x+v)),e.center.copy(g).add(y).add(T);const G=Us.set(_-P,b-R,v-x).multiplyByScalar(.5),k=new O([G[0],0,0,0,G[1],0,0,0,G[2]]);return e.halfAxes.multiplyRight(k),e}const Qt=`uniform simpleMeshUniforms {
  float sizeScale;
  bool composeModelMatrix;
  bool hasTexture;
  bool flatShading;
} simpleMesh;
`,ks={name:"simpleMesh",vs:Qt,fs:Qt,uniformTypes:{sizeScale:"f32",composeModelMatrix:"f32",hasTexture:"f32",flatShading:"f32"}},Hs=`#version 300 es
#define SHADER_NAME simple-mesh-layer-vs
in vec3 positions;
in vec3 normals;
in vec3 colors;
in vec2 texCoords;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec3 instanceModelMatrixCol0;
in vec3 instanceModelMatrixCol1;
in vec3 instanceModelMatrixCol2;
in vec3 instanceTranslation;
out vec2 vTexCoord;
out vec3 cameraPosition;
out vec3 normals_commonspace;
out vec4 position_commonspace;
out vec4 vColor;
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = texCoords;
geometry.pickingColor = instancePickingColors;
vTexCoord = texCoords;
cameraPosition = project.cameraPosition;
vColor = vec4(colors * instanceColors.rgb, instanceColors.a);
mat3 instanceModelMatrix = mat3(instanceModelMatrixCol0, instanceModelMatrixCol1, instanceModelMatrixCol2);
vec3 pos = (instanceModelMatrix * positions) * simpleMesh.sizeScale + instanceTranslation;
if (simpleMesh.composeModelMatrix) {
DECKGL_FILTER_SIZE(pos, geometry);
normals_commonspace = project_normal(instanceModelMatrix * normals);
geometry.worldPosition += pos;
gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), position_commonspace);
geometry.position = position_commonspace;
}
else {
pos = project_size(pos);
DECKGL_FILTER_SIZE(pos, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, position_commonspace);
geometry.position = position_commonspace;
normals_commonspace = project_normal(instanceModelMatrix * normals);
}
geometry.normal = normals_commonspace;
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,js=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs
precision highp float;
uniform sampler2D sampler;
in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
geometry.uv = vTexCoord;
vec3 normal;
if (simpleMesh.flatShading) {
normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
} else {
normal = normals_commonspace;
}
vec4 color = simpleMesh.hasTexture ? texture(sampler, vTexCoord) : vColor;
DECKGL_FILTER_COLOR(color, geometry);
vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
fragColor = vec4(lightColor, color.a * layer.opacity);
}
`;function st(n){const e=n.positions||n.POSITION;jn.assert(e,'no "postions" or "POSITION" attribute in mesh');const t=e.value.length/e.size;let i=n.COLOR_0||n.colors;i||(i={size:3,value:new Float32Array(t*3).fill(1)});let s=n.NORMAL||n.normals;s||(s={size:3,value:new Float32Array(t*3).fill(0)});let r=n.TEXCOORD_0||n.texCoords;return r||(r={size:2,value:new Float32Array(t*2).fill(0)}),{positions:e,colors:i,normals:s,texCoords:r}}function Kt(n){return n instanceof Ne?(n.attributes=st(n.attributes),n):n.attributes?new Ne({...n,topology:"triangle-list",attributes:st(n.attributes)}):new Ne({topology:"triangle-list",attributes:st(n)})}const Ws=[0,0,0,255],Zs={mesh:{type:"object",value:null,async:!0},texture:{type:"image",value:null,async:!0},sizeScale:{type:"number",value:1,min:0},_instanced:!0,wireframe:!1,material:!0,getPosition:{type:"accessor",value:n=>n.position},getColor:{type:"accessor",value:Ws},getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},textureParameters:{type:"object",ignore:!0,value:null}};class Pt extends Gn{getShaders(){return super.getShaders({vs:Hs,fs:js,modules:[kn,Kn,Hn,ks]})}getBounds(){if(this.props._instanced)return super.getBounds();let e=this.state.positionBounds;if(e)return e;const{mesh:t}=this.props;if(!t)return null;if(e=t.header?.boundingBox,!e){const{attributes:i}=Kt(t);i.POSITION=i.POSITION||i.positions,e=Ki(i)}return this.state.positionBounds=e,e}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{transition:!0,type:"float64",fp64:this.use64bitPositions(),size:3,accessor:"getPosition"},instanceColors:{type:"unorm8",transition:!0,size:this.props.colorFormat.length,accessor:"getColor",defaultValue:[0,0,0,255]},instanceModelMatrix:Ji}),this.setState({emptyTexture:this.context.device.createTexture({data:new Uint8Array(4),width:1,height:1})})}updateState(e){super.updateState(e);const{props:t,oldProps:i,changeFlags:s}=e;if(t.mesh!==i.mesh||s.extensionsChanged){if(this.state.positionBounds=null,this.state.model?.destroy(),t.mesh){this.state.model=this.getModel(t.mesh);const r=t.mesh.attributes||t.mesh;this.setState({hasNormals:!!(r.NORMAL||r.normals)})}this.getAttributeManager().invalidateAll()}t.texture!==i.texture&&t.texture instanceof zi&&this.setTexture(t.texture),this.state.model&&this.state.model.setTopology(this.props.wireframe?"line-strip":"triangle-list")}finalizeState(e){super.finalizeState(e),this.state.emptyTexture.delete()}draw({uniforms:e}){const{model:t}=this.state;if(!t)return;const{viewport:i,renderPass:s}=this.context,{sizeScale:r,coordinateSystem:o,_instanced:a}=this.props,c={sizeScale:r,composeModelMatrix:!a||es(i,o),flatShading:!this.state.hasNormals};t.shaderInputs.setProps({simpleMesh:c}),t.draw(s)}get isLoaded(){return!!(this.state?.model&&super.isLoaded)}getModel(e){const t=new It(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:Kt(e),isInstanced:!0}),{texture:i}=this.props,{emptyTexture:s}=this.state,r={sampler:i||s,hasTexture:!!i};return t.shaderInputs.setProps({simpleMesh:r}),t}setTexture(e){const{emptyTexture:t,model:i}=this.state;if(i){const s={sampler:e||t,hasTexture:!!e};i.shaderInputs.setProps({simpleMesh:s})}}}Pt.defaultProps=Zs;Pt.layerName="SimpleMeshLayer";const Jt=`uniform meshUniforms {
  bool pickFeatureIds;
} mesh;
`,$s={name:"mesh",vs:Jt,fs:Jt,uniformTypes:{pickFeatureIds:"f32"}},Ys=`#version 300 es
#define SHADER_NAME simple-mesh-layer-vs
in vec3 positions;
in vec3 normals;
in vec3 colors;
in vec2 texCoords;
in vec4 uvRegions;
in vec3 featureIdsPickingColors;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec3 instanceModelMatrixCol0;
in vec3 instanceModelMatrixCol1;
in vec3 instanceModelMatrixCol2;
out vec2 vTexCoord;
out vec3 cameraPosition;
out vec3 normals_commonspace;
out vec4 position_commonspace;
out vec4 vColor;
vec2 applyUVRegion(vec2 uv) {
#ifdef HAS_UV_REGIONS
return fract(uv) * (uvRegions.zw - uvRegions.xy) + uvRegions.xy;
#else
return uv;
#endif
}
void main(void) {
vec2 uv = applyUVRegion(texCoords);
geometry.uv = uv;
if (mesh.pickFeatureIds) {
geometry.pickingColor = featureIdsPickingColors;
} else {
geometry.pickingColor = instancePickingColors;
}
mat3 instanceModelMatrix = mat3(instanceModelMatrixCol0, instanceModelMatrixCol1, instanceModelMatrixCol2);
vTexCoord = uv;
cameraPosition = project.cameraPosition;
vColor = vec4(colors * instanceColors.rgb, instanceColors.a);
vec3 pos = (instanceModelMatrix * positions) * simpleMesh.sizeScale;
vec3 projectedPosition = project_position(positions);
position_commonspace = vec4(projectedPosition, 1.0);
gl_Position = project_common_position_to_clipspace(position_commonspace);
geometry.position = position_commonspace;
normals_commonspace = project_normal(instanceModelMatrix * normals);
geometry.normal = normals_commonspace;
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
#ifdef MODULE_PBRMATERIAL
pbr_vPosition = geometry.position.xyz;
#ifdef HAS_NORMALS
pbr_vNormal = geometry.normal;
#endif
#ifdef HAS_UV
pbr_vUV = uv;
#else
pbr_vUV = vec2(0., 0.);
#endif
geometry.uv = pbr_vUV;
#endif
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Xs=`#version 300 es
#define SHADER_NAME simple-mesh-layer-fs
precision highp float;
uniform sampler2D sampler;
in vec2 vTexCoord;
in vec3 cameraPosition;
in vec3 normals_commonspace;
in vec4 position_commonspace;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
#ifdef MODULE_PBRMATERIAL
fragColor = vColor * pbr_filterColor(vec4(0));
geometry.uv = pbr_vUV;
fragColor.a *= layer.opacity;
#else
geometry.uv = vTexCoord;
vec3 normal;
if (simpleMesh.flatShading) {
normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));
} else {
normal = normals_commonspace;
}
vec4 color = simpleMesh.hasTexture ? texture(sampler, vTexCoord) : vColor;
vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);
fragColor = vec4(lightColor, color.a * layer.opacity);
#endif
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`;function Qs(n){const e=n.positions||n.POSITION,t=e.value.length/e.size;n.COLOR_0||n.colors||(n.colors={size:4,value:new Uint8Array(t*4).fill(255),normalized:!0})}const Ks={pbrMaterial:{type:"object",value:null},featureIds:{type:"array",value:null,optional:!0}};class Rt extends Pt{getShaders(){const e=super.getShaders();return e.modules.push(ts,$s),{...e,vs:Ys,fs:Xs}}initializeState(){const{featureIds:e}=this.props;super.initializeState();const t=this.getAttributeManager();e&&t.add({featureIdsPickingColors:{type:"uint8",size:3,noAlloc:!0,update:this.calculateFeatureIdsPickingColors}})}updateState(e){super.updateState(e);const{props:t,oldProps:i}=e;t.pbrMaterial!==i.pbrMaterial&&this.updatePbrMaterialUniforms(t.pbrMaterial)}draw(e){const{featureIds:t}=this.props,{model:i}=this.state;if(!i)return;const s={pickFeatureIds:!!t},r={camera:this.context.viewport.cameraPosition};i.shaderInputs.setProps({pbrProjection:r,mesh:s}),super.draw(e)}getModel(e){const{id:t}=this.props,i=this.parseMaterial(this.props.pbrMaterial,e);this.setState({parsedPBRMaterial:i});const s=this.getShaders();return Qs(e.attributes),new It(this.context.device,{...this.getShaders(),id:t,geometry:e,bufferLayout:this.getAttributeManager().getBufferLayouts(),defines:{...s.defines,...i?.defines,HAS_UV_REGIONS:e.attributes.uvRegions?1:0},parameters:i?.parameters,isInstanced:!0})}updatePbrMaterialUniforms(e){const{model:t}=this.state;if(t){const{mesh:i}=this.props,s=this.parseMaterial(e,i);this.setState({parsedPBRMaterial:s});const{pbr_baseColorSampler:r}=s.bindings,{emptyTexture:o}=this.state,a={sampler:r||o,hasTexture:!!r},{camera:c,...l}={...s.bindings,...s.uniforms};t.shaderInputs.setProps({simpleMesh:a,pbrMaterial:l})}}parseMaterial(e,t){const i=!!(e.pbrMetallicRoughness&&e.pbrMetallicRoughness.baseColorTexture);return ns(this.context.device,{unlit:i,...e},{NORMAL:t.attributes.normals,TEXCOORD_0:t.attributes.texCoords},{pbrDebug:!1,lights:!0,useTangents:!1})}calculateFeatureIdsPickingColors(e){const t=this.props.featureIds,i=new Uint8ClampedArray(t.length*e.size),s=[];for(let r=0;r<t.length;r++)this.encodePickingColor(t[r],s),i[r*3]=s[0],i[r*3+1]=s[1],i[r*3+2]=s[2];e.value=i}finalizeState(e){super.finalizeState(e),this.state.parsedPBRMaterial?.generatedTextures.forEach(t=>t.destroy()),this.setState({parsedPBRMaterial:null})}}Rt.layerName="MeshLayer";Rt.defaultProps=Ks;const Js=6378137,er=6378137,tr=6356752314245179e-9;function et(n){return n}new d;function nr(n,e=[],t=et){return"longitude"in n?(e[0]=t(n.longitude),e[1]=t(n.latitude),e[2]=n.height):"x"in n?(e[0]=t(n.x),e[1]=t(n.y),e[2]=n.z):(e[0]=t(n[0]),e[1]=t(n[1]),e[2]=n[2]),e}function ir(n,e=[]){return nr(n,e,Xe._cartographicRadians?et:Gi)}function sr(n,e,t=et){return"longitude"in e?(e.longitude=t(n[0]),e.latitude=t(n[1]),e.height=n[2]):"x"in e?(e.x=t(n[0]),e.y=t(n[1]),e.z=n[2]):(e[0]=t(n[0]),e[1]=t(n[1]),e[2]=n[2]),e}function rr(n,e){return sr(n,e,Xe._cartographicRadians?et:Fi)}const en=1e-14,or=new d,tn={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},rt={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},Ie={east:new d,north:new d,up:new d,west:new d,south:new d,down:new d},ar=new d,cr=new d,lr=new d;function nn(n,e,t,i,s,r){const o=tn[e]&&tn[e][t];ie(o&&(!i||i===o));let a,c,l;const u=or.copy(s);if(Ee(u.x,0,en)&&Ee(u.y,0,en)){const f=Math.sign(u.z);a=ar.fromArray(rt[e]),e!=="east"&&e!=="west"&&a.scale(f),c=cr.fromArray(rt[t]),t!=="east"&&t!=="west"&&c.scale(f),l=lr.fromArray(rt[i]),i!=="east"&&i!=="west"&&l.scale(f)}else{const{up:f,east:p,north:g}=Ie;p.set(-u.y,u.x,0).normalize(),n.geodeticSurfaceNormal(u,f),g.copy(f).cross(p);const{down:y,west:T,south:_}=Ie;y.copy(f).scale(-1),T.copy(p).scale(-1),_.copy(g).scale(-1),a=Ie[e],c=Ie[t],l=Ie[i]}return r[0]=a.x,r[1]=a.y,r[2]=a.z,r[3]=0,r[4]=c.x,r[5]=c.y,r[6]=c.z,r[7]=0,r[8]=l.x,r[9]=l.y,r[10]=l.z,r[11]=0,r[12]=u.x,r[13]=u.y,r[14]=u.z,r[15]=1,r}const ge=new d,ur=new d,hr=new d;function dr(n,e,t=[]){const{oneOverRadii:i,oneOverRadiiSquared:s,centerToleranceSquared:r}=e;ge.from(n);const o=ge.x,a=ge.y,c=ge.z,l=i.x,u=i.y,h=i.z,f=o*o*l*l,p=a*a*u*u,g=c*c*h*h,y=f+p+g,T=Math.sqrt(1/y);if(!Number.isFinite(T))return;const _=ur;if(_.copy(n).scale(T),y<r)return _.to(t);const b=s.x,v=s.y,P=s.z,R=hr;R.set(_.x*b*2,_.y*v*2,_.z*P*2);let x=(1-T)*ge.len()/(.5*R.len()),G=0,k,L,M,oe;do{x-=G,k=1/(1+x*b),L=1/(1+x*v),M=1/(1+x*P);const pe=k*k,De=L*L,ae=M*M,Le=pe*k,Me=De*L,me=ae*M;oe=f*pe+p*De+g*ae-1;const Gt=-2*(f*Le*b+p*Me*v+g*me*P);G=oe/Gt}while(Math.abs(oe)>ms);return ge.scale([k,L,M]).to(t)}const ke=new d,sn=new d,fr=new d,$=new d,pr=new d,He=new d;class S{constructor(e=0,t=0,i=0){this.centerToleranceSquared=ps,ie(e>=0),ie(t>=0),ie(i>=0),this.radii=new d(e,t,i),this.radiiSquared=new d(e*e,t*t,i*i),this.radiiToTheFourth=new d(e*e*e*e,t*t*t*t,i*i*i*i),this.oneOverRadii=new d(e===0?0:1/e,t===0?0:1/t,i===0?0:1/i),this.oneOverRadiiSquared=new d(e===0?0:1/(e*e),t===0?0:1/(t*t),i===0?0:1/(i*i)),this.minimumRadius=Math.min(e,t,i),this.maximumRadius=Math.max(e,t,i),this.radiiSquared.z!==0&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(e){return this===e||!!(e&&this.radii.equals(e.radii))}toString(){return this.radii.toString()}cartographicToCartesian(e,t=[0,0,0]){const i=sn,s=fr,[,,r]=e;this.geodeticSurfaceNormalCartographic(e,i),s.copy(this.radiiSquared).scale(i);const o=Math.sqrt(i.dot(s));return s.scale(1/o),i.scale(r),s.add(i),s.to(t)}cartesianToCartographic(e,t=[0,0,0]){He.from(e);const i=this.scaleToGeodeticSurface(He,$);if(!i)return;const s=this.geodeticSurfaceNormal(i,sn),r=pr;r.copy(He).subtract(i);const o=Math.atan2(s.y,s.x),a=Math.asin(s.z),c=Math.sign(ki(r,He))*Hi(r);return rr([o,a,c],t)}eastNorthUpToFixedFrame(e,t=new I){return nn(this,"east","north","up",e,t)}localFrameToFixedFrame(e,t,i,s,r=new I){return nn(this,e,t,i,s,r)}geocentricSurfaceNormal(e,t=[0,0,0]){return ke.from(e).normalize().to(t)}geodeticSurfaceNormalCartographic(e,t=[0,0,0]){const i=ir(e),s=i[0],r=i[1],o=Math.cos(r);return ke.set(o*Math.cos(s),o*Math.sin(s),Math.sin(r)).normalize(),ke.to(t)}geodeticSurfaceNormal(e,t=[0,0,0]){return ke.from(e).scale(this.oneOverRadiiSquared).normalize().to(t)}scaleToGeodeticSurface(e,t){return dr(e,this,t)}scaleToGeocentricSurface(e,t=[0,0,0]){$.from(e);const i=$.x,s=$.y,r=$.z,o=this.oneOverRadiiSquared,a=1/Math.sqrt(i*i*o.x+s*s*o.y+r*r*o.z);return $.multiplyScalar(a).to(t)}transformPositionToScaledSpace(e,t=[0,0,0]){return $.from(e).scale(this.oneOverRadii).to(t)}transformPositionFromScaledSpace(e,t=[0,0,0]){return $.from(e).scale(this.radii).to(t)}getSurfaceNormalIntersectionWithZAxis(e,t=0,i=[0,0,0]){ie(Ee(this.radii.x,this.radii.y,Qn)),ie(this.radii.z>0),$.from(e);const s=$.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(s)>=this.radii.z-t))return $.set(0,0,s).to(i)}}S.WGS84=new S(Js,er,tr);class mr{item;previous;next;constructor(e,t,i){this.item=e,this.previous=t,this.next=i}}class gr{head=null;tail=null;_length=0;get length(){return this._length}add(e){const t=new mr(e,this.tail,null);return this.tail?(this.tail.next=t,this.tail=t):(this.head=t,this.tail=t),++this._length,t}remove(e){e&&(e.previous&&e.next?(e.previous.next=e.next,e.next.previous=e.previous):e.previous?(e.previous.next=null,this.tail=e.previous):e.next?(e.next.previous=null,this.head=e.next):(this.head=null,this.tail=null),e.next=null,e.previous=null,--this._length)}splice(e,t){e!==t&&(this.remove(t),this._insert(e,t))}_insert(e,t){const i=e.next;e.next=t,this.tail===e?this.tail=t:i.previous=t,t.next=i,t.previous=e,++this._length}}class yr{_list;_sentinel;_trimTiles;constructor(){this._list=new gr,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(e){const t=e._cacheNode;t&&this._list.splice(this._sentinel,t)}add(e,t,i){t._cacheNode||(t._cacheNode=this._list.add(t),i&&i(e,t))}unloadTile(e,t,i){const s=t._cacheNode;s&&(this._list.remove(s),t._cacheNode=null,i&&i(e,t))}unloadTiles(e,t){const i=this._trimTiles;this._trimTiles=!1;const s=this._list,r=e.maximumMemoryUsage*1024*1024,o=this._sentinel;let a=s.head;for(;a!==o&&(e.gpuMemoryUsageInBytes>r||i);){const c=a.item;a=a.next,this.unloadTile(e,c,t)}}trim(){this._trimTiles=!0}}function Tr(n,e){N(n),N(e);const{rtcCenter:t,gltfUpAxis:i}=e,{computedTransform:s,boundingVolume:{center:r}}=n;let o=new I(s);switch(t&&o.translate(t),i){case"Z":break;case"Y":const h=new I().rotateX(Math.PI/2);o=o.multiplyRight(h);break;case"X":const f=new I().rotateY(-Math.PI/2);o=o.multiplyRight(f);break}e.isQuantized&&o.translate(e.quantizedVolumeOffset).scale(e.quantizedVolumeScale);const a=new d(r);e.cartesianModelMatrix=o,e.cartesianOrigin=a;const c=S.WGS84.cartesianToCartographic(a,new d),u=S.WGS84.eastNorthUpToFixedFrame(a).invert();e.cartographicModelMatrix=u.multiplyRight(o),e.cartographicOrigin=c,e.coordinateSystem||(e.modelMatrix=e.cartographicModelMatrix)}const rn=new d,ot=new d,Ct=new H([new J,new J,new J,new J,new J,new J]);function _r(n,e){const{cameraDirection:t,cameraUp:i,height:s}=n,{metersPerUnit:r}=n.distanceScales,o=$e(n,n.center),a=S.WGS84.eastNorthUpToFixedFrame(o),c=n.unprojectPosition(n.cameraPosition),l=S.WGS84.cartographicToCartesian(c,new d),u=new d(a.transformAsVector(new d(t).scale(r))).normalize(),h=new d(a.transformAsVector(new d(i).scale(r))).normalize();Cr(n);const f=n.constructor,{longitude:p,latitude:g,width:y,bearing:T,zoom:_}=n,b=new f({longitude:p,latitude:g,height:s,width:y,bearing:T,zoom:_,pitch:0});return{camera:{position:l,direction:u,up:h},viewport:n,topDownViewport:b,height:s,cullingVolume:Ct,frameNumber:e,sseDenominator:1.15}}function wr(n,e,t){if(t===0||n.length<=t)return[n,[]];const i=[],{longitude:s,latitude:r}=e.viewport;for(const[l,u]of n.entries()){const[h,f]=u.header.mbs,p=Math.abs(s-h),g=Math.abs(r-f),y=Math.sqrt(g*g+p*p);i.push([l,y])}const o=i.sort((l,u)=>l[1]-u[1]),a=[];for(let l=0;l<t;l++)a.push(n[o[l][0]]);const c=[];for(let l=t;l<o.length;l++)c.push(n[o[l][0]]);return[a,c]}function Cr(n){const e=n.getFrustumPlanes(),t=on(e.near,n.cameraPosition),i=$e(n,t),s=$e(n,n.cameraPosition,ot);let r=0;Ct.planes[r++].fromPointNormal(i,rn.copy(i).subtract(s));for(const o in e){if(o==="near")continue;const a=e[o],c=on(a,t,ot),l=$e(n,c,ot);Ct.planes[r++].fromPointNormal(l,rn.copy(i).subtract(l))}}function on(n,e,t=new d){const i=n.normal.dot(e);return t.copy(n.normal).scale(n.distance-i).add(e),t}function $e(n,e,t=new d){const i=n.unprojectPosition(e);return S.WGS84.cartographicToCartesian(i,t)}const Er=6378137,br=6378137,Et=6356752314245179e-9,Te=new d;function Sr(n,e){if(n instanceof Oe){const{halfAxes:t}=n,i=Mr(t);return Math.log2(Et/(i+e[2]))}else if(n instanceof Re){const{radius:t}=n;return Math.log2(Et/(t+e[2]))}else if(n.width&&n.height){const{width:t,height:i}=n,s=Math.log2(Er/t),r=Math.log2(br/i);return(s+r)/2}return 1}function ti(n,e,t){S.WGS84.cartographicToCartesian([n.xmax,n.ymax,n.zmax],Te);const i=Math.sqrt(Math.pow(Te[0]-t[0],2)+Math.pow(Te[1]-t[1],2)+Math.pow(Te[2]-t[2],2));return Math.log2(Et/(i+e[2]))}function Lr(n,e,t){const[i,s,r,o]=n;return ti({xmax:r,ymax:o,zmax:0},e,t)}function Mr(n){n.getColumn(0,Te);const e=n.getColumn(1),t=n.getColumn(2);return Te.add(e).add(t).len()}const z={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5};var X;(function(n){n[n.ADD=1]="ADD",n[n.REPLACE=2]="REPLACE"})(X||(X={}));var se;(function(n){n.EMPTY="empty",n.SCENEGRAPH="scenegraph",n.POINTCLOUD="pointcloud",n.MESH="mesh"})(se||(se={}));var B;(function(n){n.I3S="I3S",n.TILES3D="TILES3D"})(B||(B={}));var be;(function(n){n.GEOMETRIC_ERROR="geometricError",n.MAX_SCREEN_THRESHOLD="maxScreenThreshold"})(be||(be={}));const vr={USE_OPTIMIZATION:1};function ni(n){return n!=null}const D=new d,Ye=new d,Ir=new d,Ar=new d,he=new d,an=new d,cn=new d,ln=new d;function at(n,e,t){if(N(n,"3D Tile: boundingVolume must be defined"),n.box)return ii(n.box,e,t);if(n.region)return Pr(n.region);if(n.sphere)return Nr(n.sphere,e,t);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function xr(n,e){if(n.box)return Rr(e);if(n.region){const[t,i,s,r,o,a]=n.region;return[[K(t),K(i),o],[K(s),K(r),a]]}if(n.sphere)return Or(e);throw new Error("Unkown boundingVolume type")}function ii(n,e,t){const i=new d(n[0],n[1],n[2]);e.transform(i,i);let s=[];if(n.length===10){const l=n.slice(3,6),u=new Qe;u.fromArray(n,6);const h=new d([1,0,0]),f=new d([0,1,0]),p=new d([0,0,1]);h.transformByQuaternion(u),h.scale(l[0]),f.transformByQuaternion(u),f.scale(l[1]),p.transformByQuaternion(u),p.scale(l[2]),s=[...h.toArray(),...f.toArray(),...p.toArray()]}else s=[...n.slice(3,6),...n.slice(6,9),...n.slice(9,12)];const r=e.transformAsVector(s.slice(0,3)),o=e.transformAsVector(s.slice(3,6)),a=e.transformAsVector(s.slice(6,9)),c=new O([r[0],r[1],r[2],o[0],o[1],o[2],a[0],a[1],a[2]]);return ni(t)?(t.center=i,t.halfAxes=c,t):new Oe(i,c)}function Nr(n,e,t){const i=new d(n[0],n[1],n[2]);e.transform(i,i);const s=e.getScale(Ye),r=Math.max(Math.max(s[0],s[1]),s[2]),o=n[3]*r;return ni(t)?(t.center=i,t.radius=o,t):new Re(i,o)}function Pr(n){const[e,t,i,s,r,o]=n,a=S.WGS84.cartographicToCartesian([K(e),K(s),r],Ir),c=S.WGS84.cartographicToCartesian([K(i),K(t),o],Ar),l=new d().addVectors(a,c).multiplyByScalar(.5);return S.WGS84.cartesianToCartographic(l,he),S.WGS84.cartographicToCartesian([K(i),he[1],he[2]],an),S.WGS84.cartographicToCartesian([he[0],K(s),he[2]],cn),S.WGS84.cartographicToCartesian([he[0],he[1],o],ln),ii([...l,...an.subtract(l),...cn.subtract(l),...ln.subtract(l)],new I)}function Rr(n){const e=si(),{halfAxes:t}=n,i=new d(t.getColumn(0)),s=new d(t.getColumn(1)),r=new d(t.getColumn(2));for(let o=0;o<2;o++){for(let a=0;a<2;a++){for(let c=0;c<2;c++)D.copy(n.center),D.add(i),D.add(s),D.add(r),ri(e,D),r.negate();s.negate()}i.negate()}return e}function Or(n){const e=si(),{center:t,radius:i}=n,s=S.WGS84.scaleToGeodeticSurface(t,D);let r;s?r=S.WGS84.geodeticSurfaceNormal(s):r=new d(0,0,1);let o=new d(r[2],-r[1],0);o.len()>0?o.normalize():o=new d(0,1,0);const a=o.clone().cross(r);for(const c of[o,a,r]){Ye.copy(c).scale(i);for(let l=0;l<2;l++)D.copy(t),D.add(Ye),ri(e,D),Ye.negate()}return e}function si(){return[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]]}function ri(n,e){S.WGS84.cartesianToCartographic(e,D),n[0][0]=Math.min(n[0][0],D[0]),n[0][1]=Math.min(n[0][1],D[1]),n[0][2]=Math.min(n[0][2],D[2]),n[1][0]=Math.max(n[1][0],D[0]),n[1][1]=Math.max(n[1][1],D[1]),n[1][2]=Math.max(n[1][2],D[2])}new d;new d;new I;new d;new d;new d;function Dr(n,e){const t=n*e;return 1-Math.exp(-(t*t))}function Ur(n,e){if(n.dynamicScreenSpaceError&&n.dynamicScreenSpaceErrorComputedDensity){const t=n.dynamicScreenSpaceErrorComputedDensity,i=n.dynamicScreenSpaceErrorFactor;return Dr(e,t)*i}return 0}function Vr(n,e,t){const i=n.tileset,s=n.parent&&n.parent.lodMetricValue||n.lodMetricValue,r=t?s:n.lodMetricValue;if(r===0)return 0;const o=Math.max(n._distanceToCamera,1e-7),{height:a,sseDenominator:c}=e,{viewDistanceScale:l}=i.options;let u=r*a*(l||1)/(o*c);return u-=Ur(i,o),u}const ct=new d,un=new d,ue=new d,hn=new d,Br=new d,lt=new I,dn=new I;function qr(n,e){if(n.lodMetricValue===0||isNaN(n.lodMetricValue))return"DIG";const t=2*oi(n,e);return t<2?"OUT":!n.header.children||t<=n.lodMetricValue?"DRAW":n.header.children?"DIG":"OUT"}function oi(n,e){const{topDownViewport:t}=e,i=n.header.mbs[1],s=n.header.mbs[0],r=n.header.mbs[2],o=n.header.mbs[3],a=[...n.boundingVolume.center],c=t.unprojectPosition(t.cameraPosition);S.WGS84.cartographicToCartesian(c,ct),un.copy(ct).subtract(a).normalize(),S.WGS84.eastNorthUpToFixedFrame(a,lt),dn.copy(lt).invert(),ue.copy(ct).transform(dn);const l=Math.sqrt(ue[0]*ue[0]+ue[1]*ue[1]),u=l*l/ue[2];hn.copy([ue[0],ue[1],u]);const f=hn.transform(lt).subtract(a).normalize(),g=un.cross(f).normalize().scale(o).add(a),y=S.WGS84.cartesianToCartographic(g),T=t.project([s,i,r]),_=t.project(y);return Br.copy(T).subtract(_).magnitude()}function zr(n){return{assetGltfUpAxis:n.asset&&n.asset.gltfUpAxis||"Y"}}class fn{_map=new Map;_array;_length;constructor(e=0){this._array=new Array(e),this._length=e}get length(){return this._length}set length(e){this._length=e,e>this._array.length&&(this._array.length=e)}get values(){return this._array}get(e){return N(e<this._array.length),this._array[e]}set(e,t){N(e>=0),e>=this.length&&(this.length=e+1),this._map.has(this._array[e])&&this._map.delete(this._array[e]),this._array[e]=t,this._map.set(t,e)}delete(e){const t=this._map.get(e);t>=0&&(this._array.splice(t,1),this._map.delete(e),this.length--)}peek(){return this._array[this._length-1]}push(e){if(!this._map.has(e)){const t=this.length++;this._array[t]=e,this._map.set(e,t)}}pop(){const e=this._array[--this.length];return this._map.delete(e),e}reserve(e){N(e>=0),e>this._array.length&&(this._array.length=e)}resize(e){N(e>=0),this.length=e}trim(e){e==null&&(e=this.length),this._array.length=e}reset(){this._array=[],this._map=new Map,this._length=0}find(e){return this._map.has(e)}}const Fr={loadSiblings:!1,skipLevelOfDetail:!1,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class tt{options;root=null;selectedTiles={};requestedTiles={};emptyTiles={};lastUpdate=new Date().getTime();updateDebounceTime=1e3;_traversalStack=new fn;_emptyTraversalStack=new fn;_frameNumber=null;traversalFinished(e){return!0}constructor(e){this.options={...Fr,...e}}traverse(e,t,i){this.root=e,this.options={...this.options,...i},this.reset(),this.updateTile(e,t),this._frameNumber=t.frameNumber,this.executeTraversal(e,t)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(e,t){const i=this._traversalStack;for(e._selectionDepth=1,i.push(e);i.length>0;){const r=i.pop();let o=!1;this.canTraverse(r,t)&&(this.updateChildTiles(r,t),o=this.updateAndPushChildren(r,t,i,r.hasRenderContent?r._selectionDepth+1:r._selectionDepth));const a=r.parent,c=!!(!a||a._shouldRefine),l=!o;r.hasRenderContent?r.refine===X.ADD?(this.loadTile(r,t),this.selectTile(r,t)):r.refine===X.REPLACE&&(this.loadTile(r,t),l&&this.selectTile(r,t)):(this.emptyTiles[r.id]=r,this.loadTile(r,t),l&&this.selectTile(r,t)),this.touchTile(r,t),r._shouldRefine=o&&c}const s=new Date().getTime();(this.traversalFinished(t)||s-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=s,this.options.onTraversalEnd(t))}updateChildTiles(e,t){const i=e.children;for(const s of i)this.updateTile(s,t)}updateAndPushChildren(e,t,i,s){const{loadSiblings:r,skipLevelOfDetail:o}=this.options,a=e.children;a.sort(this.compareDistanceToCamera.bind(this));const c=e.refine===X.REPLACE&&e.hasRenderContent&&!o;let l=!1,u=!0;for(const h of a)if(h._selectionDepth=s,h.isVisibleAndInRequestVolume?(i.find(h)&&i.delete(h),i.push(h),l=!0):(c||r)&&(this.loadTile(h,t),this.touchTile(h,t)),c){let f;if(h._inRequestVolume?h.hasRenderContent?f=h.contentAvailable:f=this.executeEmptyTraversal(h,t):f=!1,u=u&&f,!u)return!1}return l||(u=!1),u}updateTile(e,t){this.updateTileVisibility(e,t)}selectTile(e,t){this.shouldSelectTile(e)&&(e._selectedFrame=t.frameNumber,this.selectedTiles[e.id]=e)}loadTile(e,t){this.shouldLoadTile(e)&&(e._requestedFrame=t.frameNumber,e._priority=e._getPriority(),this.requestedTiles[e.id]=e)}touchTile(e,t){e.tileset._cache.touch(e),e._touchedFrame=t.frameNumber}canTraverse(e,t){return e.hasChildren?e.hasTilesetContent?!e.contentExpired:this.shouldRefine(e,t):!1}shouldLoadTile(e){return e.hasUnloadedContent||e.contentExpired}shouldSelectTile(e){return e.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(e,t,i=!1){let s=e._screenSpaceError;return i&&(s=e.getScreenSpaceError(t,!0)),s>e.tileset.memoryAdjustedScreenSpaceError}updateTileVisibility(e,t){const i=[];if(this.options.viewportTraversersMap)for(const s in this.options.viewportTraversersMap)this.options.viewportTraversersMap[s]===t.viewport.id&&i.push(s);else i.push(t.viewport.id);e.updateVisibility(t,i)}compareDistanceToCamera(e,t){return e._distanceToCamera-t._distanceToCamera}anyChildrenVisible(e,t){let i=!1;for(const s of e.children)s.updateVisibility(t),i=i||s.isVisibleAndInRequestVolume;return i}executeEmptyTraversal(e,t){let i=!0;const s=this._emptyTraversalStack;for(s.push(e);s.length>0;){const r=s.pop(),o=!r.hasRenderContent&&this.canTraverse(r,t),a=!r.hasRenderContent&&r.children.length===0;if(!o&&!r.contentAvailable&&!a&&(i=!1),this.updateTile(r,t),r.isVisibleAndInRequestVolume||(this.loadTile(r,t),this.touchTile(r,t)),o){const c=r.children;for(const l of c)s.push(l)}}return i}}const pn=new d;function Gr(n){return n!=null}class bt{tileset;header;id;url;parent;refine;type;contentUrl;lodMetricType="geometricError";lodMetricValue=0;boundingVolume=null;content=null;contentState=z.UNLOADED;gpuMemoryUsageInBytes=0;children=[];depth=0;viewportIds=[];transform=new I;extensions=null;implicitTiling=null;userData={};computedTransform;hasEmptyContent=!1;hasTilesetContent=!1;traverser=new tt({});_cacheNode=null;_frameNumber=null;_expireDate=null;_expiredContent=null;_boundingBox=void 0;_distanceToCamera=0;_screenSpaceError=0;_visibilityPlaneMask;_visible=void 0;_contentBoundingVolume;_viewerRequestVolume;_initialTransform=new I;_priority=0;_selectedFrame=0;_requestedFrame=0;_selectionDepth=0;_touchedFrame=0;_centerZDepth=0;_shouldRefine=!1;_stackLength=0;_visitedFrame=0;_inRequestVolume=!1;_lodJudge=null;constructor(e,t,i,s=""){this.header=t,this.tileset=e,this.id=s||t.id,this.url=t.url,this.parent=i,this.refine=this._getRefine(t.refine),this.type=t.type,this.contentUrl=t.contentUrl,this._initializeLodMetric(t),this._initializeTransforms(t),this._initializeBoundingVolumes(t),this._initializeContent(t),this._initializeRenderingState(t),Object.seal(this)}destroy(){this.header=null}isDestroyed(){return this.header===null}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===z.READY||this.hasEmptyContent}get contentAvailable(){return!!(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===z.UNLOADED}get contentExpired(){return this.contentState===z.EXPIRED}get contentFailed(){return this.contentState===z.FAILED}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}get boundingBox(){return this._boundingBox||(this._boundingBox=xr(this.header.boundingVolume,this.boundingVolume)),this._boundingBox}getScreenSpaceError(e,t){switch(this.tileset.type){case B.I3S:return oi(this,e);case B.TILES3D:return Vr(this,e,t);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getGpuMemoryUsageInBytes(){return this.content.gpuMemoryUsageInBytes||this.content.byteLength||0}_getPriority(){const e=this.tileset._traverser,{skipLevelOfDetail:t}=e.options,i=this.refine===X.ADD||t;if(i&&!this.isVisible&&this._visible!==void 0||this.tileset._frameNumber-this._touchedFrame>=1||this.contentState===z.UNLOADED)return-1;const s=this.parent,o=s&&(!i||this._screenSpaceError===0||s.hasTilesetContent)?s._screenSpaceError:this._screenSpaceError,a=e.root?e.root._screenSpaceError:0;return Math.max(a-o,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=z.LOADING;const t=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!t)return this.contentState=z.UNLOADED,!1;try{const i=this.tileset.getTileUrl(this.contentUrl),s=this.tileset.loader,r={...this.tileset.loadOptions,[s.id]:{...this.tileset.loadOptions[s.id],isTileset:this.type==="json",...this._getLoaderSpecificOptions(s.id)}};return this.content=await Pe(i,s,r),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=z.READY,this._onContentLoaded(),!0}catch(i){throw this.contentState=z.FAILED,i}finally{t.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=z.UNLOADED,!0}updateVisibility(e,t){if(this._frameNumber===e.frameNumber)return;const i=this.parent,s=i?i._visibilityPlaneMask:H.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const r=i?i.computedTransform:this.tileset.modelMatrix;this._updateTransform(r)}this._distanceToCamera=this.distanceToTile(e),this._screenSpaceError=this.getScreenSpaceError(e,!1),this._visibilityPlaneMask=this.visibility(e,s),this._visible=this._visibilityPlaneMask!==H.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(e),this._frameNumber=e.frameNumber,this.viewportIds=t}visibility(e,t){const{cullingVolume:i}=e,{boundingVolume:s}=this;return i.computeVisibilityWithPlaneMask(s,t)}contentVisibility(){return!0}distanceToTile(e){const t=this.boundingVolume;return Math.sqrt(Math.max(t.distanceSquaredTo(e.camera.position),0))}cameraSpaceZDepth({camera:e}){const t=this.boundingVolume;return pn.subVectors(t.center,e.position),e.direction.dot(pn)}insideViewerRequestVolume(e){const t=this._viewerRequestVolume;return!t||t.distanceSquaredTo(e.camera.position)<=0}updateExpiration(){if(Gr(this._expireDate)&&this.contentReady&&!this.hasEmptyContent){const e=Date.now();Date.lessThan(this._expireDate,e)&&(this.contentState=z.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(e){"lodMetricType"in e?this.lodMetricType=e.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in e?this.lodMetricValue=e.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(e){this.transform=e.transform?new I(e.transform):new I;const t=this.parent,i=this.tileset,s=t&&t.computedTransform?t.computedTransform.clone():i.modelMatrix.clone();this.computedTransform=new I(s).multiplyRight(this.transform);const r=t&&t._initialTransform?t._initialTransform.clone():new I;this._initialTransform=new I(r).multiplyRight(this.transform)}_initializeBoundingVolumes(e){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(e)}_initializeContent(e){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=z.UNLOADED,this.hasTilesetContent=!1,e.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(e){this.depth=e.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=H.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(e){return e||this.parent&&this.parent.refine||X.REPLACE}_isTileset(){return this.contentUrl.indexOf(".json")!==-1}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0;break}this._isTileset()?this.hasTilesetContent=!0:this.gpuMemoryUsageInBytes=this._getGpuMemoryUsageInBytes()}_updateBoundingVolume(e){this.boundingVolume=at(e.boundingVolume,this.computedTransform,this.boundingVolume);const t=e.content;t&&(t.boundingVolume&&(this._contentBoundingVolume=at(t.boundingVolume,this.computedTransform,this._contentBoundingVolume)),e.viewerRequestVolume&&(this._viewerRequestVolume=at(e.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(e=new I){const t=e.clone().multiplyRight(this.transform);t.equals(this.computedTransform)||(this.computedTransform=t,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(e){switch(e){case"i3s":return{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1};case"3d-tiles":case"cesium-ion":default:return zr(this.tileset.tileset)}}}class kr extends tt{compareDistanceToCamera(e,t){return t._distanceToCamera===0&&e._distanceToCamera===0?t._centerZDepth-e._centerZDepth:t._distanceToCamera-e._distanceToCamera}updateTileVisibility(e,t){if(super.updateTileVisibility(e,t),!e.isVisibleAndInRequestVolume)return;const i=e.children.length>0;if(e.hasTilesetContent&&i){const o=e.children[0];this.updateTileVisibility(o,t),e._visible=o._visible;return}if(this.meetsScreenSpaceErrorEarly(e,t)){e._visible=!1;return}const s=e.refine===X.REPLACE,r=e._optimChildrenWithinParent===vr.USE_OPTIMIZATION;if(s&&r&&i&&!this.anyChildrenVisible(e,t)){e._visible=!1;return}}meetsScreenSpaceErrorEarly(e,t){const{parent:i}=e;return!i||i.hasTilesetContent||i.refine!==X.ADD?!1:!this.shouldRefine(e,t,!0)}}class Hr{frameNumberMap=new Map;register(e,t){const i=this.frameNumberMap.get(e)||new Map,s=i.get(t)||0;i.set(t,s+1),this.frameNumberMap.set(e,i)}deregister(e,t){const i=this.frameNumberMap.get(e);if(!i)return;const s=i.get(t)||1;i.set(t,s-1)}isZero(e,t){return(this.frameNumberMap.get(e)?.get(t)||0)===0}}const ut={REQUESTED:"REQUESTED",COMPLETED:"COMPLETED",ERROR:"ERROR"};class jr{_statusMap;pendingTilesRegister=new Hr;constructor(){this._statusMap={}}add(e,t,i,s){if(!this._statusMap[t]){const{frameNumber:r,viewport:{id:o}}=s;this._statusMap[t]={request:e,callback:i,key:t,frameState:s,status:ut.REQUESTED},this.pendingTilesRegister.register(o,r),e().then(a=>{this._statusMap[t].status=ut.COMPLETED;const{frameNumber:c,viewport:{id:l}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(l,c),this._statusMap[t].callback(a,s)}).catch(a=>{this._statusMap[t].status=ut.ERROR;const{frameNumber:c,viewport:{id:l}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(l,c),i(a)})}}update(e,t){if(this._statusMap[e]){const{frameNumber:i,viewport:{id:s}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(s,i);const{frameNumber:r,viewport:{id:o}}=t;this.pendingTilesRegister.register(o,r),this._statusMap[e].frameState=t}}find(e){return this._statusMap[e]}hasPendingTiles(e,t){return!this.pendingTilesRegister.isZero(e,t)}}class Wr extends tt{_tileManager;constructor(e){super(e),this._tileManager=new jr}traversalFinished(e){return!this._tileManager.hasPendingTiles(e.viewport.id,this._frameNumber||0)}shouldRefine(e,t){return e._lodJudge=qr(e,t),e._lodJudge==="DIG"}updateChildTiles(e,t){const i=e.header.children||[],s=e.children,r=e.tileset;for(const o of i){const a=`${o.id}-${t.viewport.id}`,c=s&&s.find(l=>l.id===a);if(c)c&&this.updateTile(c,t);else{let l=()=>this._loadTile(o.id,r);this._tileManager.find(a)?this._tileManager.update(a,t):(r.tileset.nodePages&&(l=()=>r.tileset.nodePagesTile.formTileFromNodePages(o.id)),this._tileManager.add(l,a,h=>this._onTileLoad(h,e,a),t))}}return!1}async _loadTile(e,t){const{loader:i}=t,s=t.getTileUrl(`${t.url}/nodes/${e}`),r={...t.loadOptions,i3s:{...t.loadOptions.i3s,isTileHeader:!0}};return await Pe(s,i,r)}_onTileLoad(e,t,i){const s=new bt(t.tileset,e,t,i);t.children.push(s);const r=this._tileManager.find(s.id).frameState;this.updateTile(s,r),this._frameNumber===r.frameNumber&&(this.traversalFinished(r)||new Date().getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(s,r)}}const Zr={description:"",ellipsoid:S.WGS84,modelMatrix:new I,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,memoryCacheOverflow:1,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:n=>n,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,memoryAdjustedScreenSpaceError:!1,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},je="Tiles In Tileset(s)",ht="Tiles In Memory",mn="Tiles In View",gn="Tiles To Render",yn="Tiles Loaded",dt="Tiles Loading",Tn="Tiles Unloaded",_n="Failed Tile Loads",wn="Points/Vertices",ft="Tile Memory Use",Cn="Maximum Screen Space Error";class $r{options;loadOptions;type;tileset;loader;url;basePath;modelMatrix;ellipsoid;lodMetricType;lodMetricValue;refine;root=null;roots={};asset={};description="";properties;extras=null;attributions={};credits={};stats;contentFormats={draco:!1,meshopt:!1,dds:!1,ktx2:!1};cartographicCenter=null;cartesianCenter=null;zoom=1;boundingVolume=null;dynamicScreenSpaceErrorComputedDensity=0;maximumMemoryUsage=32;gpuMemoryUsageInBytes=0;memoryAdjustedScreenSpaceError=0;_cacheBytes=0;_cacheOverflowBytes=0;_frameNumber=0;_queryParams={};_extensionsUsed=[];_tiles={};_pendingCount=0;selectedTiles=[];traverseCounter=0;geometricError=0;lastUpdatedVieports=null;_requestedTiles=[];_emptyTiles=[];frameStateData={};_traverser;_cache=new yr;_requestScheduler;updatePromise=null;tilesetInitializationPromise;constructor(e,t){this.options={...Zr,...t},this.tileset=e,this.loader=e.loader,this.type=e.type,this.url=e.url,this.basePath=e.basePath||Wn(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=e.lodMetricType,this.lodMetricValue=e.lodMetricValue,this.refine=e.root.refine,this.loadOptions=this.options.loadOptions||{},this._traverser=this._initializeTraverser(),this._requestScheduler=new fs({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this.memoryAdjustedScreenSpaceError=this.options.maximumScreenSpaceError,this._cacheBytes=this.options.maximumMemoryUsage*1024*1024,this._cacheOverflowBytes=this.options.memoryCacheOverflow*1024*1024,this.stats=new Fn({id:this.url}),this._initializeStats(),this.tilesetInitializationPromise=this._initializeTileSet(e)}destroy(){this._destroy()}isLoaded(){return this._pendingCount===0&&this._frameNumber!==0&&this._requestedTiles.length===0}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return new URLSearchParams(this._queryParams).toString()}setProps(e){this.options={...this.options,...e}}getTileUrl(e){if(e.startsWith("data:"))return e;let i=e;return this.queryParams.length&&(i=`${e}${e.includes("?")?"&":"?"}${this.queryParams}`),i}hasExtension(e){return this._extensionsUsed.indexOf(e)>-1}update(e=null){this.tilesetInitializationPromise.then(()=>{!e&&this.lastUpdatedVieports?e=this.lastUpdatedVieports:this.lastUpdatedVieports=e,e&&this.doUpdate(e)})}async selectTiles(e=null){return await this.tilesetInitializationPromise,e&&(this.lastUpdatedVieports=e),this.updatePromise||(this.updatePromise=new Promise(t=>{setTimeout(()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),t(this._frameNumber),this.updatePromise=null},this.options.debounceTime)})),this.updatePromise}adjustScreenSpaceError(){this.gpuMemoryUsageInBytes<this._cacheBytes?this.memoryAdjustedScreenSpaceError=Math.max(this.memoryAdjustedScreenSpaceError/1.02,this.options.maximumScreenSpaceError):this.gpuMemoryUsageInBytes>this._cacheBytes+this._cacheOverflowBytes&&(this.memoryAdjustedScreenSpaceError*=1.02)}doUpdate(e){if("loadTiles"in this.options&&!this.options.loadTiles||this.traverseCounter>0)return;const t=e instanceof Array?e:[e];this._cache.reset(),this._frameNumber++,this.traverseCounter=t.length;const i=[];for(const s of t){const r=s.id;this._needTraverse(r)?i.push(r):this.traverseCounter--}for(const s of t){const r=s.id;if(this.roots[r]||(this.roots[r]=this._initializeTileHeaders(this.tileset,null)),!i.includes(r))continue;const o=_r(s,this._frameNumber);this._traverser.traverse(this.roots[r],o,this.options)}}_needTraverse(e){let t=e;return this.options.viewportTraversersMap&&(t=this.options.viewportTraversersMap[e]),t===e}_onTraversalEnd(e){const t=e.viewport.id;this.frameStateData[t]||(this.frameStateData[t]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const i=this.frameStateData[t],s=Object.values(this._traverser.selectedTiles),[r,o]=wr(s,e,this.options.maximumTilesSelected);i.selectedTiles=r;for(const a of o)a.unselect();i._requestedTiles=Object.values(this._traverser.requestedTiles),i._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,!(this.traverseCounter>0)&&this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const e in this.frameStateData){const t=this.frameStateData[e];this.selectedTiles=this.selectedTiles.concat(t.selectedTiles),this._requestedTiles=this._requestedTiles.concat(t._requestedTiles),this._emptyTiles=this._emptyTiles.concat(t._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const e of this.selectedTiles)this._tiles[e.id]=e;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(e,t){if(e.length!==t.length)return!0;const i=new Set(e.map(o=>o.id)),s=new Set(t.map(o=>o.id));let r=e.filter(o=>!s.has(o.id)).length>0;return r=r||t.filter(o=>!i.has(o.id)).length>0,r}_loadTiles(){for(const e of this._requestedTiles)e.contentUnloaded&&this._loadTile(e)}_unloadTiles(){this._cache.unloadTiles(this,(e,t)=>e._unloadTile(t))}_updateStats(){let e=0,t=0;for(const i of this.selectedTiles)i.contentAvailable&&i.content&&(e++,i.content.pointCount?t+=i.content.pointCount:t+=i.content.vertexCount);this.stats.get(mn).count=this.selectedTiles.length,this.stats.get(gn).count=e,this.stats.get(wn).count=t,this.stats.get(Cn).count=this.memoryAdjustedScreenSpaceError}async _initializeTileSet(e){this.type===B.I3S&&(this.calculateViewPropsI3S(),e.root=await e.root),this.root=this._initializeTileHeaders(e,null),this.type===B.TILES3D&&(this._initializeTiles3DTileset(e),this.calculateViewPropsTiles3D()),this.type===B.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){const e=this.tileset.fullExtent;if(e){const{xmin:i,xmax:s,ymin:r,ymax:o,zmin:a,zmax:c}=e;this.cartographicCenter=new d(i+(s-i)/2,r+(o-r)/2,a+(c-a)/2),this.cartesianCenter=new d,S.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),this.zoom=ti(e,this.cartographicCenter,this.cartesianCenter);return}const t=this.tileset.store?.extent;if(t){const[i,s,r,o]=t;this.cartographicCenter=new d(i+(r-i)/2,s+(o-s)/2,0),this.cartesianCenter=new d,S.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),this.zoom=Lr(t,this.cartographicCenter,this.cartesianCenter);return}console.warn("Extent is not defined in the tileset header"),this.cartographicCenter=new d,this.zoom=1}calculateViewPropsTiles3D(){const e=this.root,{center:t}=e.boundingVolume;if(!t){console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new d,this.zoom=1;return}t[0]!==0||t[1]!==0||t[2]!==0?(this.cartographicCenter=new d,S.WGS84.cartesianToCartographic(t,this.cartographicCenter)):this.cartographicCenter=new d(0,0,-S.WGS84.radii[0]),this.cartesianCenter=t,this.zoom=Sr(e.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(je),this.stats.get(dt),this.stats.get(ht),this.stats.get(mn),this.stats.get(gn),this.stats.get(yn),this.stats.get(Tn),this.stats.get(_n),this.stats.get(wn),this.stats.get(ft,"memory"),this.stats.get(Cn)}_initializeTileHeaders(e,t){const i=new bt(this,e.root,t);if(t&&(t.children.push(i),i.depth=t.depth+1),this.type===B.TILES3D){const s=[];for(s.push(i);s.length>0;){const r=s.pop();this.stats.get(je).incrementCount();const o=r.header.children||[];for(const a of o){const c=new bt(this,a,r);if(c.contentUrl?.includes("?session=")){const u=new URL(c.contentUrl).searchParams.get("session");u&&(this._queryParams.session=u)}r.children.push(c),c.depth=r.depth+1,s.push(c)}}}return i}_initializeTraverser(){let e;switch(this.type){case B.TILES3D:e=kr;break;case B.I3S:e=Wr;break;default:e=tt}return new e({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(e){this._destroySubtree(e)}async _loadTile(e){let t;try{this._onStartTileLoading(),t=await e.loadContent()}catch(i){this._onTileLoadError(e,i instanceof Error?i:new Error("load failed"))}finally{this._onEndTileLoading(),this._onTileLoad(e,t)}}_onTileLoadError(e,t){this.stats.get(_n).incrementCount();const i=t.message||t.toString(),s=e.url;console.error(`A 3D tile failed to load: ${e.url} ${i}`),this.options.onTileError(e,i,s)}_onTileLoad(e,t){if(t){if(this.type===B.I3S){const i=this.tileset?.nodePagesTile?.nodesInNodePages||0;this.stats.get(je).reset(),this.stats.get(je).addCount(i)}e&&e.content&&Tr(e,e.content),this.updateContentTypes(e),this._addTileToCache(e),this.options.onTileLoad(e)}}updateContentTypes(e){if(this.type===B.I3S)switch(e.header.isDracoGeometry&&(this.contentFormats.draco=!0),e.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0;break}else if(this.type===B.TILES3D){const{extensionsRemoved:t=[]}=e.content?.gltf||{};t.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),t.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),t.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(dt).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(dt).decrementCount()}_addTileToCache(e){this._cache.add(this,e,t=>t._updateCacheStats(e))}_updateCacheStats(e){this.stats.get(yn).incrementCount(),this.stats.get(ht).incrementCount(),this.gpuMemoryUsageInBytes+=e.gpuMemoryUsageInBytes||0,this.stats.get(ft).count=this.gpuMemoryUsageInBytes,this.options.memoryAdjustedScreenSpaceError&&this.adjustScreenSpaceError()}_unloadTile(e){this.gpuMemoryUsageInBytes-=e.gpuMemoryUsageInBytes||0,this.stats.get(ht).decrementCount(),this.stats.get(Tn).incrementCount(),this.stats.get(ft).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(e),e.unloadContent()}_destroy(){const e=[];for(this.root&&e.push(this.root);e.length>0;){const t=e.pop();for(const i of t.children)e.push(i);this._destroyTile(t)}this.root=null}_destroySubtree(e){const t=e,i=[];for(i.push(t);i.length>0;){e=i.pop();for(const s of e.children)i.push(s);e!==t&&this._destroyTile(e)}t.children=[]}_destroyTile(e){this._cache.unloadTile(this,e),this._unloadTile(e),e.destroy()}_initializeTiles3DTileset(e){if(e.queryString){const t=new URLSearchParams(e.queryString),i=Object.fromEntries(t.entries());this._queryParams={...this._queryParams,...i}}if(this.asset=e.asset,!this.asset)throw new Error("Tileset must have an asset property.");if(this.asset.version!=="0.0"&&this.asset.version!=="1.0"&&this.asset.version!=="1.1")throw new Error("The tileset must be 3D Tiles version either 0.0 or 1.0 or 1.1.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=e.properties,this.geometricError=e.geometricError,this._extensionsUsed=e.extensionsUsed||[],this.extras=e.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}const ai="4.3.3",Ae={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GLTF:"glTF"};function ci(n,e,t){N(n instanceof ArrayBuffer);const i=new TextDecoder("utf8"),s=new Uint8Array(n,e,t);return i.decode(s)}function Yr(n,e=0){const t=new DataView(n);return`${String.fromCharCode(t.getUint8(e+0))}${String.fromCharCode(t.getUint8(e+1))}${String.fromCharCode(t.getUint8(e+2))}${String.fromCharCode(t.getUint8(e+3))}`}const Xr={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},A={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},w={...Xr,...A},pt={[A.DOUBLE]:Float64Array,[A.FLOAT]:Float32Array,[A.UNSIGNED_SHORT]:Uint16Array,[A.UNSIGNED_INT]:Uint32Array,[A.UNSIGNED_BYTE]:Uint8Array,[A.BYTE]:Int8Array,[A.SHORT]:Int16Array,[A.INT]:Int32Array},Qr={DOUBLE:A.DOUBLE,FLOAT:A.FLOAT,UNSIGNED_SHORT:A.UNSIGNED_SHORT,UNSIGNED_INT:A.UNSIGNED_INT,UNSIGNED_BYTE:A.UNSIGNED_BYTE,BYTE:A.BYTE,SHORT:A.SHORT,INT:A.INT},mt="Failed to convert GL type";class te{static fromTypedArray(e){e=ArrayBuffer.isView(e)?e.constructor:e;for(const t in pt)if(pt[t]===e)return t;throw new Error(mt)}static fromName(e){const t=Qr[e];if(!t)throw new Error(mt);return t}static getArrayType(e){switch(e){case A.UNSIGNED_SHORT_5_6_5:case A.UNSIGNED_SHORT_4_4_4_4:case A.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const t=pt[e];if(!t)throw new Error(mt);return t}}static getByteSize(e){return te.getArrayType(e).BYTES_PER_ELEMENT}static validate(e){return!!te.getArrayType(e)}static createTypedArray(e,t,i=0,s){s===void 0&&(s=(t.byteLength-i)/te.getByteSize(e));const r=te.getArrayType(e);return new r(t,i,s)}}function Kr(n,e){if(!n)throw new Error(`math.gl assertion failed. ${e}`)}function Jr(n,e=[0,0,0]){const t=n>>11&31,i=n>>5&63,s=n&31;return e[0]=t<<3,e[1]=i<<2,e[2]=s<<3,e}new xt;new d;new xt;new xt;function En(n,e=255){return ji(n,0,e)/e*2-1}function bn(n){return n<0?-1:1}function eo(n,e,t,i){if(Kr(i),n<0||n>t||e<0||e>t)throw new Error(`x and y must be unsigned normalized integers between 0 and ${t}`);if(i.x=En(n,t),i.y=En(e,t),i.z=1-(Math.abs(i.x)+Math.abs(i.y)),i.z<0){const s=i.x;i.x=(1-Math.abs(i.y))*bn(s),i.y=(1-Math.abs(s))*bn(i.y)}return i.normalize()}function to(n,e,t){return eo(n,e,255,t)}class Ot{json;buffer;featuresLength=0;_cachedTypedArrays={};constructor(e,t){this.json=e,this.buffer=t}getExtension(e){return this.json.extensions&&this.json.extensions[e]}hasProperty(e){return!!this.json[e]}getGlobalProperty(e,t=w.UNSIGNED_INT,i=1){const s=this.json[e];return s&&Number.isFinite(s.byteOffset)?this._getTypedArrayFromBinary(e,t,i,1,s.byteOffset):s}getPropertyArray(e,t,i){const s=this.json[e];return s&&Number.isFinite(s.byteOffset)?("componentType"in s&&(t=te.fromName(s.componentType)),this._getTypedArrayFromBinary(e,t,i,this.featuresLength,s.byteOffset)):this._getTypedArrayFromArray(e,t,s)}getProperty(e,t,i,s,r){const o=this.json[e];if(!o)return o;const a=this.getPropertyArray(e,t,i);if(i===1)return a[s];for(let c=0;c<i;++c)r[c]=a[i*s+c];return r}_getTypedArrayFromBinary(e,t,i,s,r){const o=this._cachedTypedArrays;let a=o[e];return a||(a=te.createTypedArray(t,this.buffer.buffer,this.buffer.byteOffset+r,s*i),o[e]=a),a}_getTypedArrayFromArray(e,t,i){const s=this._cachedTypedArrays;let r=s[e];return r||(r=te.createTypedArray(t,i),s[e]=r),r}}const no={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},io={SCALAR:(n,e)=>n[e],VEC2:(n,e)=>[n[2*e+0],n[2*e+1]],VEC3:(n,e)=>[n[3*e+0],n[3*e+1],n[3*e+2]],VEC4:(n,e)=>[n[4*e+0],n[4*e+1],n[4*e+2],n[4*e+3]],MAT2:(n,e)=>[n[4*e+0],n[4*e+1],n[4*e+2],n[4*e+3]],MAT3:(n,e)=>[n[9*e+0],n[9*e+1],n[9*e+2],n[9*e+3],n[9*e+4],n[9*e+5],n[9*e+6],n[9*e+7],n[9*e+8]],MAT4:(n,e)=>[n[16*e+0],n[16*e+1],n[16*e+2],n[16*e+3],n[16*e+4],n[16*e+5],n[16*e+6],n[16*e+7],n[16*e+8],n[16*e+9],n[16*e+10],n[16*e+11],n[16*e+12],n[16*e+13],n[16*e+14],n[16*e+15]]},so={SCALAR:(n,e,t)=>{e[t]=n},VEC2:(n,e,t)=>{e[2*t+0]=n[0],e[2*t+1]=n[1]},VEC3:(n,e,t)=>{e[3*t+0]=n[0],e[3*t+1]=n[1],e[3*t+2]=n[2]},VEC4:(n,e,t)=>{e[4*t+0]=n[0],e[4*t+1]=n[1],e[4*t+2]=n[2],e[4*t+3]=n[3]},MAT2:(n,e,t)=>{e[4*t+0]=n[0],e[4*t+1]=n[1],e[4*t+2]=n[2],e[4*t+3]=n[3]},MAT3:(n,e,t)=>{e[9*t+0]=n[0],e[9*t+1]=n[1],e[9*t+2]=n[2],e[9*t+3]=n[3],e[9*t+4]=n[4],e[9*t+5]=n[5],e[9*t+6]=n[6],e[9*t+7]=n[7],e[9*t+8]=n[8],e[9*t+9]=n[9]},MAT4:(n,e,t)=>{e[16*t+0]=n[0],e[16*t+1]=n[1],e[16*t+2]=n[2],e[16*t+3]=n[3],e[16*t+4]=n[4],e[16*t+5]=n[5],e[16*t+6]=n[6],e[16*t+7]=n[7],e[16*t+8]=n[8],e[16*t+9]=n[9],e[16*t+10]=n[10],e[16*t+11]=n[11],e[16*t+12]=n[12],e[16*t+13]=n[13],e[16*t+14]=n[14],e[16*t+15]=n[15]}};function ro(n,e,t,i){const{componentType:s}=n;N(n.componentType);const r=typeof s=="string"?te.fromName(s):s,o=no[n.type],a=io[n.type],c=so[n.type];return t+=n.byteOffset,{values:te.createTypedArray(r,e,t,o*i),type:r,size:o,unpacker:a,packer:c}}const ee=n=>n!==void 0;function oo(n,e,t){if(!e)return null;let i=n.getExtension("3DTILES_batch_table_hierarchy");const s=e.HIERARCHY;return s&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),e.extensions=e.extensions||{},e.extensions["3DTILES_batch_table_hierarchy"]=s,i=s),i?ao(i,t):null}function ao(n,e){let t,i,s;const r=n.instancesLength,o=n.classes;let a=n.classIds,c=n.parentCounts,l=n.parentIds,u=r;ee(a.byteOffset)&&(a.componentType=defaultValue(a.componentType,GL.UNSIGNED_SHORT),a.type=AttributeType.SCALAR,s=getBinaryAccessor(a),a=s.createArrayBufferView(e.buffer,e.byteOffset+a.byteOffset,r));let h;if(ee(c))for(ee(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,s=getBinaryAccessor(c),c=s.createArrayBufferView(e.buffer,e.byteOffset+c.byteOffset,r)),h=new Uint16Array(r),u=0,t=0;t<r;++t)h[t]=u,u+=c[t];ee(l)&&ee(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,s=getBinaryAccessor(l),l=s.createArrayBufferView(e.buffer,e.byteOffset+l.byteOffset,u));const f=o.length;for(t=0;t<f;++t){const T=o[t].length,_=o[t].instances,b=getBinaryProperties(T,_,e);o[t].instances=combine(b,_)}const p=new Array(f).fill(0),g=new Uint16Array(r);for(t=0;t<r;++t)i=a[t],g[t]=p[i],++p[i];const y={classes:o,classIds:a,classIndexes:g,parentCounts:c,parentIndexes:h,parentIds:l};return uo(y),y}function xe(n,e,t){if(!n)return;const i=n.parentCounts;return n.parentIds?t(n,e):i>0?co(n,e,t):lo(n,e,t)}function co(n,e,t){const i=n.classIds,s=n.parentCounts,r=n.parentIds,o=n.parentIndexes,a=i.length,c=scratchVisited;c.length=Math.max(c.length,a);const l=++marker,u=scratchStack;for(u.length=0,u.push(e);u.length>0;){if(e=u.pop(),c[e]===l)continue;c[e]=l;const h=t(n,e);if(ee(h))return h;const f=s[e],p=o[e];for(let g=0;g<f;++g){const y=r[p+g];y!==e&&u.push(y)}}return null}function lo(n,e,t){let i=!0;for(;i;){const s=t(n,e);if(ee(s))return s;const r=n.parentIds[e];i=r!==e,e=r}throw new Error("traverseHierarchySingleParent")}function uo(n){const t=n.classIds.length;for(let i=0;i<t;++i)li(n,i,stack)}function li(n,e,t){const i=n.parentCounts,s=n.parentIds,r=n.parentIndexes,a=n.classIds.length;if(!ee(s))return;assert(e<a,`Parent index ${e} exceeds the total number of instances: ${a}`),assert(t.indexOf(e)===-1,"Circular dependency detected in the batch table hierarchy."),t.push(e);const c=ee(i)?i[e]:1,l=ee(i)?r[e]:e;for(let u=0;u<c;++u){const h=s[l+u];h!==e&&li(n,h,t)}t.pop(e)}function V(n){return n!=null}const We=(n,e)=>n,ho={HIERARCHY:!0,extensions:!0,extras:!0};class ui{json;binary;featureCount;_extensions;_properties;_binaryProperties;_hierarchy;constructor(e,t,i,s={}){N(i>=0),this.json=e||{},this.binary=t,this.featureCount=i,this._extensions=this.json?.extensions||{},this._properties={};for(const r in this.json)ho[r]||(this._properties[r]=this.json[r]);this._binaryProperties=this._initializeBinaryProperties(),s["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=oo(this,this.json,this.binary))}getExtension(e){return this.json&&this.json.extensions&&this.json.extensions[e]}memorySizeInBytes(){return 0}isClass(e,t){if(this._checkBatchId(e),N(typeof t=="string",t),this._hierarchy){const i=xe(this._hierarchy,e,(s,r)=>{const o=s.classIds[r];return s.classes[o].name===t});return V(i)}return!1}isExactClass(e,t){return N(typeof t=="string",t),this.getExactClassName(e)===t}getExactClassName(e){if(this._checkBatchId(e),this._hierarchy){const t=this._hierarchy.classIds[e];return this._hierarchy.classes[t].name}}hasProperty(e,t){return this._checkBatchId(e),N(typeof t=="string",t),V(this._properties[t])||this._hasPropertyInHierarchy(e,t)}getPropertyNames(e,t){this._checkBatchId(e),t=V(t)?t:[],t.length=0;const i=Object.keys(this._properties);return t.push(...i),this._hierarchy&&this._getPropertyNamesInHierarchy(e,t),t}getProperty(e,t){if(this._checkBatchId(e),N(typeof t=="string",t),this._binaryProperties){const s=this._binaryProperties[t];if(V(s))return this._getBinaryProperty(s,e)}const i=this._properties[t];if(V(i))return We(i[e]);if(this._hierarchy){const s=this._getHierarchyProperty(e,t);if(V(s))return s}}setProperty(e,t,i){const s=this.featureCount;if(this._checkBatchId(e),N(typeof t=="string",t),this._binaryProperties){const o=this._binaryProperties[t];if(o){this._setBinaryProperty(o,e,i);return}}if(this._hierarchy&&this._setHierarchyProperty(this,e,t,i))return;let r=this._properties[t];V(r)||(this._properties[t]=new Array(s),r=this._properties[t]),r[e]=We(i)}_checkBatchId(e){if(!(e>=0&&e<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(e,t){return e.unpack(e.typedArray,t)}_setBinaryProperty(e,t,i){e.pack(i,e.typedArray,t)}_initializeBinaryProperties(){let e=null;for(const t in this._properties){const i=this._properties[t],s=this._initializeBinaryProperty(t,i);s&&(e=e||{},e[t]=s)}return e}_initializeBinaryProperty(e,t){if("byteOffset"in t){const i=t;N(this.binary,`Property ${e} requires a batch table binary.`),N(i.type,`Property ${e} requires a type.`);const s=ro(i,this.binary.buffer,this.binary.byteOffset|0,this.featureCount);return{typedArray:s.values,componentCount:s.size,unpack:s.unpacker,pack:s.packer}}return null}_hasPropertyInHierarchy(e,t){if(!this._hierarchy)return!1;const i=xe(this._hierarchy,e,(s,r)=>{const o=s.classIds[r],a=s.classes[o].instances;return V(a[t])});return V(i)}_getPropertyNamesInHierarchy(e,t){xe(this._hierarchy,e,(i,s)=>{const r=i.classIds[s],o=i.classes[r].instances;for(const a in o)o.hasOwnProperty(a)&&t.indexOf(a)===-1&&t.push(a)})}_getHierarchyProperty(e,t){return xe(this._hierarchy,e,(i,s)=>{const r=i.classIds[s],o=i.classes[r],a=i.classIndexes[s],c=o.instances[t];return V(c)?V(c.typedArray)?this._getBinaryProperty(c,a):We(c[a]):null})}_setHierarchyProperty(e,t,i,s){const r=xe(this._hierarchy,t,(o,a)=>{const c=o.classIds[a],l=o.classes[c],u=o.classIndexes[a],h=l.instances[i];return V(h)?(N(a===t,`Inherited property "${i}" is read-only.`),V(h.typedArray)?this._setBinaryProperty(h,u,s):h[u]=We(s),!0):!1});return V(r)}}const gt=4;function nt(n,e,t=0){const i=new DataView(e);if(n.magic=i.getUint32(t,!0),t+=gt,n.version=i.getUint32(t,!0),t+=gt,n.byteLength=i.getUint32(t,!0),t+=gt,n.version!==1)throw new Error(`3D Tile Version ${n.version} not supported`);return t}const ye=4,Sn="b3dm tile in legacy format.";function Dt(n,e,t){const i=new DataView(e);let s;n.header=n.header||{};let r=i.getUint32(t,!0);t+=ye;let o=i.getUint32(t,!0);t+=ye;let a=i.getUint32(t,!0);t+=ye;let c=i.getUint32(t,!0);return t+=ye,a>=570425344?(t-=ye*2,s=r,a=o,c=0,r=0,o=0,console.warn(Sn)):c>=570425344&&(t-=ye,s=a,a=r,c=o,r=0,o=0,console.warn(Sn)),n.header.featureTableJsonByteLength=r,n.header.featureTableBinaryByteLength=o,n.header.batchTableJsonByteLength=a,n.header.batchTableBinaryByteLength=c,n.header.batchLength=s,t}function Ut(n,e,t,i){return t=fo(n,e,t),t=po(n,e,t),t}function fo(n,e,t,i){const{featureTableJsonByteLength:s,featureTableBinaryByteLength:r,batchLength:o}=n.header||{};if(n.featureTableJson={BATCH_LENGTH:o||0},s&&s>0){const a=ci(e,t,s);n.featureTableJson=JSON.parse(a)}return t+=s||0,n.featureTableBinary=new Uint8Array(e,t,r),t+=r||0,t}function po(n,e,t,i){const{batchTableJsonByteLength:s,batchTableBinaryByteLength:r}=n.header||{};if(s&&s>0){const o=ci(e,t,s);n.batchTableJson=JSON.parse(o),t+=s,r&&r>0&&(n.batchTableBinary=new Uint8Array(e,t,r),n.batchTableBinary=new Uint8Array(n.batchTableBinary),t+=r)}return t}function hi(n,e,t){if(!e&&(!n||!n.batchIds||!t))return null;const{batchIds:i,isRGB565:s,pointCount:r=0}=n;if(i&&t){const o=new Uint8ClampedArray(r*3);for(let a=0;a<r;a++){const c=i[a],u=t.getProperty(c,"dimensions").map(h=>h*255);o[a*3]=u[0],o[a*3+1]=u[1],o[a*3+2]=u[2]}return{type:w.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}if(e&&s){const o=new Uint8ClampedArray(r*3);for(let a=0;a<r;a++){const c=Jr(e[a]);o[a*3]=c[0],o[a*3+1]=c[1],o[a*3+2]=c[2]}return{type:w.UNSIGNED_BYTE,value:o,size:3,normalized:!0}}return e&&e.length===r*3?{type:w.UNSIGNED_BYTE,value:e,size:3,normalized:!0}:{type:w.UNSIGNED_BYTE,value:e||new Uint8ClampedArray,size:4,normalized:!0}}const Ln=new d;function mo(n,e){if(!e)return null;if(n.isOctEncoded16P){const t=new Float32Array((n.pointsLength||0)*3);for(let i=0;i<(n.pointsLength||0);i++)to(e[i*2],e[i*2+1],Ln),Ln.toArray(t,i*3);return{type:w.FLOAT,size:2,value:t}}return{type:w.FLOAT,size:2,value:e}}function go(n,e,t){return n.isQuantized?t["3d-tiles"]&&t["3d-tiles"].decodeQuantizedPositions?(n.isQuantized=!1,yo(n,e)):{type:w.UNSIGNED_SHORT,value:e,size:3,normalized:!0}:e}function yo(n,e){const t=new d,i=new Float32Array(n.pointCount*3);for(let s=0;s<n.pointCount;s++)t.set(e[s*3],e[s*3+1],e[s*3+2]).scale(1/n.quantizedRange).multiply(n.quantizedVolumeScale).add(n.quantizedVolumeOffset).toArray(i,s*3);return i}async function To(n,e,t,i,s){t=nt(n,e,t),t=Dt(n,e,t),t=Ut(n,e,t),_o(n);const{featureTable:r,batchTable:o}=wo(n);return await Lo(n,r,o,i,s),Co(n,r,i),Eo(n,r,o),bo(n,r),t}function _o(n){n.attributes={positions:null,colors:null,normals:null,batchIds:null},n.isQuantized=!1,n.isTranslucent=!1,n.isRGB565=!1,n.isOctEncoded16P=!1}function wo(n){const e=new Ot(n.featureTableJson,n.featureTableBinary),t=e.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(t))throw new Error("POINTS_LENGTH must be defined");e.featuresLength=t,n.featuresLength=t,n.pointsLength=t,n.pointCount=t,n.rtcCenter=e.getGlobalProperty("RTC_CENTER",w.FLOAT,3);const i=So(n,e);return{featureTable:e,batchTable:i}}function Co(n,e,t){if(n.attributes=n.attributes||{positions:null,colors:null,normals:null,batchIds:null},!n.attributes.positions){if(e.hasProperty("POSITION"))n.attributes.positions=e.getPropertyArray("POSITION",w.FLOAT,3);else if(e.hasProperty("POSITION_QUANTIZED")){const i=e.getPropertyArray("POSITION_QUANTIZED",w.UNSIGNED_SHORT,3);if(n.isQuantized=!0,n.quantizedRange=65535,n.quantizedVolumeScale=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",w.FLOAT,3),!n.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(n.quantizedVolumeOffset=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",w.FLOAT,3),!n.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");n.attributes.positions=go(n,i,t)}}if(!n.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}function Eo(n,e,t){if(n.attributes=n.attributes||{positions:null,colors:null,normals:null,batchIds:null},!n.attributes.colors){let i=null;e.hasProperty("RGBA")?(i=e.getPropertyArray("RGBA",w.UNSIGNED_BYTE,4),n.isTranslucent=!0):e.hasProperty("RGB")?i=e.getPropertyArray("RGB",w.UNSIGNED_BYTE,3):e.hasProperty("RGB565")&&(i=e.getPropertyArray("RGB565",w.UNSIGNED_SHORT,1),n.isRGB565=!0),n.attributes.colors=hi(n,i,t)}e.hasProperty("CONSTANT_RGBA")&&(n.constantRGBA=e.getGlobalProperty("CONSTANT_RGBA",w.UNSIGNED_BYTE,4))}function bo(n,e){if(n.attributes=n.attributes||{positions:null,colors:null,normals:null,batchIds:null},!n.attributes.normals){let t=null;e.hasProperty("NORMAL")?t=e.getPropertyArray("NORMAL",w.FLOAT,3):e.hasProperty("NORMAL_OCT16P")&&(t=e.getPropertyArray("NORMAL_OCT16P",w.UNSIGNED_BYTE,2),n.isOctEncoded16P=!0),n.attributes.normals=mo(n,t)}}function So(n,e){let t=null;if(!n.batchIds&&e.hasProperty("BATCH_ID")&&(n.batchIds=e.getPropertyArray("BATCH_ID",w.UNSIGNED_SHORT,1),n.batchIds)){const i=e.getGlobalProperty("BATCH_LENGTH");if(!i)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:s,batchTableBinary:r}=n;t=new ui(s,r,i)}return t}async function Lo(n,e,t,i,s){let r,o,a;const c=n.batchTableJson&&n.batchTableJson.extensions&&n.batchTableJson.extensions["3DTILES_draco_point_compression"];c&&(a=c.properties);const l=e.getExtension("3DTILES_draco_point_compression");if(l){o=l.properties;const h=l.byteOffset,f=l.byteLength;if(!o||!Number.isFinite(h)||!f)throw new Error("Draco properties, byteOffset, and byteLength must be defined");r=(n.featureTableBinary||[]).slice(h,h+f),n.hasPositions=Number.isFinite(o.POSITION),n.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),n.hasNormals=Number.isFinite(o.NORMAL),n.hasBatchIds=Number.isFinite(o.BATCH_ID),n.isTranslucent=Number.isFinite(o.RGBA)}if(!r)return!0;const u={buffer:r,properties:{...o,...a},batchTableProperties:a};return await Mo(n,u,i,s)}async function Mo(n,e,t,i){if(!i)return;const s={...t,draco:{...t?.draco,extraAttributes:e.batchTableProperties||{}}};delete s["3d-tiles"];const r=await At(e.buffer,is,s,i),o=r.attributes.POSITION&&r.attributes.POSITION.value,a=r.attributes.COLOR_0&&r.attributes.COLOR_0.value,c=r.attributes.NORMAL&&r.attributes.NORMAL.value,l=r.attributes.BATCH_ID&&r.attributes.BATCH_ID.value,u=o&&r.attributes.POSITION.value.quantization,h=c&&r.attributes.NORMAL.value.quantization;if(u){const p=r.POSITION.data.quantization,g=p.range;n.quantizedVolumeScale=new d(g,g,g),n.quantizedVolumeOffset=new d(p.minValues),n.quantizedRange=(1<<p.quantizationBits)-1,n.isQuantizedDraco=!0}h&&(n.octEncodedRange=(1<<r.NORMAL.data.quantization.quantizationBits)-1,n.isOctEncodedDraco=!0);const f={};if(e.batchTableProperties)for(const p of Object.keys(e.batchTableProperties))r.attributes[p]&&r.attributes[p].value&&(f[p.toLowerCase()]=r.attributes[p].value);n.attributes={positions:o,colors:hi(n,a,void 0),normals:c,batchIds:l,...f}}const St={URI:0,EMBEDDED:1};function di(n,e,t,i){n.rotateYtoZ=!0;const s=(n.byteOffset||0)+(n.byteLength||0)-t;if(s===0)throw new Error("glTF byte length must be greater than 0.");return n.gltfUpAxis=i?.["3d-tiles"]&&i["3d-tiles"].assetGltfUpAxis?i["3d-tiles"].assetGltfUpAxis:"Y",n.gltfArrayBuffer=Wi(e,t,s),n.gltfByteOffset=0,n.gltfByteLength=s,t%4===0||console.warn(`${n.type}: embedded glb is not aligned to a 4-byte boundary.`),(n.byteOffset||0)+(n.byteLength||0)}async function fi(n,e,t,i){const s=t?.["3d-tiles"]||{};if(vo(n,e),s.loadGLTF){if(!i)return;if(n.gltfUrl){const{fetch:r}=i,o=await r(n.gltfUrl,t);n.gltfArrayBuffer=await o.arrayBuffer(),n.gltfByteOffset=0}if(n.gltfArrayBuffer){const r=await At(n.gltfArrayBuffer,Zn,t,i);n.gltf=$n(r),n.gpuMemoryUsageInBytes=Yn(n.gltf),delete n.gltfArrayBuffer,delete n.gltfByteOffset,delete n.gltfByteLength}}}function vo(n,e,t){switch(e){case St.URI:if(n.gltfArrayBuffer){const i=new Uint8Array(n.gltfArrayBuffer,n.gltfByteOffset),r=new TextDecoder().decode(i);n.gltfUrl=r.replace(/[\s\0]+$/,"")}delete n.gltfArrayBuffer,delete n.gltfByteOffset,delete n.gltfByteLength;break;case St.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}async function Io(n,e,t,i,s){t=Ao(n,e,t,i),await fi(n,St.EMBEDDED,i,s);const r=n?.gltf?.extensions;return r&&r.CESIUM_RTC&&(n.rtcCenter=r.CESIUM_RTC.center),t}function Ao(n,e,t,i,s){t=nt(n,e,t),t=Dt(n,e,t),t=Ut(n,e,t),t=di(n,e,t,i);const r=new Ot(n.featureTableJson,n.featureTableBinary);return n.rtcCenter=r.getGlobalProperty("RTC_CENTER",w.FLOAT,3),t}async function xo(n,e,t,i,s){return t=No(n,e,t,i),await fi(n,n.gltfFormat||0,i,s),t}function No(n,e,t,i,s){if(t=nt(n,e,t),n.version!==1)throw new Error(`Instanced 3D Model version ${n.version} is not supported`);t=Dt(n,e,t);const r=new DataView(e);if(n.gltfFormat=r.getUint32(t,!0),t+=4,t=Ut(n,e,t),t=di(n,e,t,i),!n?.header?.featureTableJsonByteLength||n.header.featureTableJsonByteLength===0)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new Ot(n.featureTableJson,n.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");n.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),n.rtcCenter=o.getGlobalProperty("RTC_CENTER",w.FLOAT,3);const c=new ui(n.batchTableJson,n.batchTableBinary,a);return Po(n,o,c,a),t}function Po(n,e,t,i){const s=new Array(i),r=new d;new d,new d,new d;const o=new O,a=new Qe,c=new d,l={},u=new I,h=[],f=[],p=[],g=[];for(let y=0;y<i;y++){let T;if(e.hasProperty("POSITION"))T=e.getProperty("POSITION",w.FLOAT,3,y,r);else if(e.hasProperty("POSITION_QUANTIZED")){T=e.getProperty("POSITION_QUANTIZED",w.UNSIGNED_SHORT,3,y,r);const x=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",w.FLOAT,3);if(!x)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const G=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",w.FLOAT,3);if(!G)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const k=65535;for(let L=0;L<3;L++)T[L]=T[L]/k*G[L]+x[L]}if(!T)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(r.copy(T),l.translation=r,n.normalUp=e.getProperty("NORMAL_UP",w.FLOAT,3,y,h),n.normalRight=e.getProperty("NORMAL_RIGHT",w.FLOAT,3,y,f),n.normalUp){if(!n.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");n.hasCustomOrientation=!0}else{if(n.octNormalUp=e.getProperty("NORMAL_UP_OCT32P",w.UNSIGNED_SHORT,2,y,h),n.octNormalRight=e.getProperty("NORMAL_RIGHT_OCT32P",w.UNSIGNED_SHORT,2,y,f),n.octNormalUp)throw n.octNormalRight?new Error("i3dm: oct-encoded orientation not implemented"):new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");n.eastNorthUp?(S.WGS84.eastNorthUpToFixedFrame(r,u),u.getRotationMatrix3(o)):o.identity()}a.fromMatrix3(o),l.rotation=a,c.set(1,1,1);const _=e.getProperty("SCALE",w.FLOAT,1,y,p);Number.isFinite(_)&&c.multiplyByScalar(_);const b=e.getProperty("SCALE_NON_UNIFORM",w.FLOAT,3,y,h);b&&c.scale(b),l.scale=c;let v=e.getProperty("BATCH_ID",w.UNSIGNED_SHORT,1,y,g);v===void 0&&(v=y);const P=new I().fromQuaternion(l.rotation);u.identity(),u.translate(l.translation),u.multiplyRight(P),u.scale(l.scale);const R=u.clone();s[y]={modelMatrix:R,batchId:v}}n.instances=s}async function Ro(n,e,t,i,s,r){t=nt(n,e,t);const o=new DataView(e);for(n.tilesLength=o.getUint32(t,!0),t+=4,n.tiles=[];n.tiles.length<n.tilesLength&&(n.byteLength||0)-t>12;){const a={shape:"tile3d"};n.tiles.push(a),t=await r(e,t,i,s,a)}return t}async function Oo(n,e,t,i){if(n.rotateYtoZ=!0,n.gltfUpAxis=t?.["3d-tiles"]?.assetGltfUpAxis?t["3d-tiles"].assetGltfUpAxis:"Y",t?.["3d-tiles"]?.loadGLTF){if(!i)return e.byteLength;const s=await At(e,Zn,t,i);n.gltf=$n(s),n.gpuMemoryUsageInBytes=Yn(n.gltf)}else n.gltfArrayBuffer=e;return e.byteLength}async function pi(n,e=0,t,i,s={shape:"tile3d"}){switch(s.byteOffset=e,s.type=Yr(n,e),s.type){case Ae.COMPOSITE:return await Ro(s,n,e,t,i,pi);case Ae.BATCHED_3D_MODEL:return await Io(s,n,e,t,i);case Ae.GLTF:return await Oo(s,n,t,i);case Ae.INSTANCED_3D_MODEL:return await xo(s,n,e,t,i);case Ae.POINT_CLOUD:return await To(s,n,e,t,i);default:throw new Error(`3DTileLoader: unknown type ${s.type}`)}}const Do=1952609651,Uo=1;async function Vo(n,e,t){if(new Uint32Array(n.slice(0,4))[0]!==Do)throw new Error("Wrong subtree file magic number");if(new Uint32Array(n.slice(4,8))[0]!==Uo)throw new Error("Wrong subtree file verson, must be 1");const r=Mn(n.slice(8,16)),o=new Uint8Array(n,24,r),c=new TextDecoder("utf8").decode(o),l=JSON.parse(c),u=Mn(n.slice(16,24));let h=new ArrayBuffer(0);if(u&&(h=n.slice(24+r)),await Ze(l,l.tileAvailability,h,t),Array.isArray(l.contentAvailability))for(const f of l.contentAvailability)await Ze(l,f,h,t);else await Ze(l,l.contentAvailability,h,t);return await Ze(l,l.childSubtreeAvailability,h,t),l}async function Ze(n,e,t,i){const s=Number.isFinite(e.bitstream)?e.bitstream:e.bufferView;if(typeof s!="number")return;const r=n.bufferViews[s],o=n.buffers[r.buffer];if(!i?.baseUrl)throw new Error("Url is not provided");if(!i.fetch)throw new Error("fetch is not provided");if(o.uri){const c=`${i?.baseUrl||""}/${o.uri}`,u=await(await i.fetch(c)).arrayBuffer();e.explicitBitstream=new Uint8Array(u,r.byteOffset,r.byteLength);return}const a=n.buffers.slice(0,r.buffer).reduce((c,l)=>c+l.byteLength,0);e.explicitBitstream=new Uint8Array(t.slice(a,a+o.byteLength),r.byteOffset,r.byteLength)}function Mn(n){const e=new DataView(n),t=e.getUint32(0,!0),i=e.getUint32(4,!0);return t+2**32*i}const mi={dataType:null,batchType:null,id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:ai,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:Vo,options:{}};/**
 * @license
 * Copyright 2009 The Closure Library Authors
 * Copyright 2020 Daniel Wirtz / The long.js Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */var j=null;try{j=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch{}function E(n,e,t){this.low=n|0,this.high=e|0,this.unsigned=!!t}E.prototype.__isLong__;Object.defineProperty(E.prototype,"__isLong__",{value:!0});function U(n){return(n&&n.__isLong__)===!0}function vn(n){var e=Math.clz32(n&-n);return n?31-e:e}E.isLong=U;var In={},An={};function fe(n,e){var t,i,s;return e?(n>>>=0,(s=0<=n&&n<256)&&(i=An[n],i)?i:(t=C(n,0,!0),s&&(An[n]=t),t)):(n|=0,(s=-128<=n&&n<128)&&(i=In[n],i)?i:(t=C(n,n<0?-1:0,!1),s&&(In[n]=t),t))}E.fromInt=fe;function W(n,e){if(isNaN(n))return e?re:Y;if(e){if(n<0)return re;if(n>=gi)return _i}else{if(n<=-Nn)return q;if(n+1>=Nn)return Ti}return n<0?W(-n,e).neg():C(n%Se|0,n/Se|0,e)}E.fromNumber=W;function C(n,e,t){return new E(n,e,t)}E.fromBits=C;var Ke=Math.pow;function Vt(n,e,t){if(n.length===0)throw Error("empty string");if(typeof e=="number"?(t=e,e=!1):e=!!e,n==="NaN"||n==="Infinity"||n==="+Infinity"||n==="-Infinity")return e?re:Y;if(t=t||10,t<2||36<t)throw RangeError("radix");var i;if((i=n.indexOf("-"))>0)throw Error("interior hyphen");if(i===0)return Vt(n.substring(1),e,t).neg();for(var s=W(Ke(t,8)),r=Y,o=0;o<n.length;o+=8){var a=Math.min(8,n.length-o),c=parseInt(n.substring(o,o+a),t);if(a<8){var l=W(Ke(t,a));r=r.mul(l).add(W(c))}else r=r.mul(s),r=r.add(W(c))}return r.unsigned=e,r}E.fromString=Vt;function Z(n,e){return typeof n=="number"?W(n,e):typeof n=="string"?Vt(n,e):C(n.low,n.high,typeof e=="boolean"?e:n.unsigned)}E.fromValue=Z;var xn=65536,Bo=1<<24,Se=xn*xn,gi=Se*Se,Nn=gi/2,Pn=fe(Bo),Y=fe(0);E.ZERO=Y;var re=fe(0,!0);E.UZERO=re;var _e=fe(1);E.ONE=_e;var yi=fe(1,!0);E.UONE=yi;var Lt=fe(-1);E.NEG_ONE=Lt;var Ti=C(-1,2147483647,!1);E.MAX_VALUE=Ti;var _i=C(-1,-1,!0);E.MAX_UNSIGNED_VALUE=_i;var q=C(0,-2147483648,!1);E.MIN_VALUE=q;var m=E.prototype;m.toInt=function(){return this.unsigned?this.low>>>0:this.low};m.toNumber=function(){return this.unsigned?(this.high>>>0)*Se+(this.low>>>0):this.high*Se+(this.low>>>0)};m.toString=function(e){if(e=e||10,e<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(q)){var t=W(e),i=this.div(t),s=i.mul(t).sub(this);return i.toString(e)+s.toInt().toString(e)}else return"-"+this.neg().toString(e);for(var r=W(Ke(e,6),this.unsigned),o=this,a="";;){var c=o.div(r),l=o.sub(c.mul(r)).toInt()>>>0,u=l.toString(e);if(o=c,o.isZero())return u+a;for(;u.length<6;)u="0"+u;a=""+u+a}};m.getHighBits=function(){return this.high};m.getHighBitsUnsigned=function(){return this.high>>>0};m.getLowBits=function(){return this.low};m.getLowBitsUnsigned=function(){return this.low>>>0};m.getNumBitsAbs=function(){if(this.isNegative())return this.eq(q)?64:this.neg().getNumBitsAbs();for(var e=this.high!=0?this.high:this.low,t=31;t>0&&(e&1<<t)==0;t--);return this.high!=0?t+33:t+1};m.isSafeInteger=function(){var e=this.high>>21;return e?this.unsigned?!1:e===-1&&!(this.low===0&&this.high===-2097152):!0};m.isZero=function(){return this.high===0&&this.low===0};m.eqz=m.isZero;m.isNegative=function(){return!this.unsigned&&this.high<0};m.isPositive=function(){return this.unsigned||this.high>=0};m.isOdd=function(){return(this.low&1)===1};m.isEven=function(){return(this.low&1)===0};m.equals=function(e){return U(e)||(e=Z(e)),this.unsigned!==e.unsigned&&this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low};m.eq=m.equals;m.notEquals=function(e){return!this.eq(e)};m.neq=m.notEquals;m.ne=m.notEquals;m.lessThan=function(e){return this.comp(e)<0};m.lt=m.lessThan;m.lessThanOrEqual=function(e){return this.comp(e)<=0};m.lte=m.lessThanOrEqual;m.le=m.lessThanOrEqual;m.greaterThan=function(e){return this.comp(e)>0};m.gt=m.greaterThan;m.greaterThanOrEqual=function(e){return this.comp(e)>=0};m.gte=m.greaterThanOrEqual;m.ge=m.greaterThanOrEqual;m.compare=function(e){if(U(e)||(e=Z(e)),this.eq(e))return 0;var t=this.isNegative(),i=e.isNegative();return t&&!i?-1:!t&&i?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1};m.comp=m.compare;m.negate=function(){return!this.unsigned&&this.eq(q)?q:this.not().add(_e)};m.neg=m.negate;m.add=function(e){U(e)||(e=Z(e));var t=this.high>>>16,i=this.high&65535,s=this.low>>>16,r=this.low&65535,o=e.high>>>16,a=e.high&65535,c=e.low>>>16,l=e.low&65535,u=0,h=0,f=0,p=0;return p+=r+l,f+=p>>>16,p&=65535,f+=s+c,h+=f>>>16,f&=65535,h+=i+a,u+=h>>>16,h&=65535,u+=t+o,u&=65535,C(f<<16|p,u<<16|h,this.unsigned)};m.subtract=function(e){return U(e)||(e=Z(e)),this.add(e.neg())};m.sub=m.subtract;m.multiply=function(e){if(this.isZero())return this;if(U(e)||(e=Z(e)),j){var t=j.mul(this.low,this.high,e.low,e.high);return C(t,j.get_high(),this.unsigned)}if(e.isZero())return this.unsigned?re:Y;if(this.eq(q))return e.isOdd()?q:Y;if(e.eq(q))return this.isOdd()?q:Y;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(Pn)&&e.lt(Pn))return W(this.toNumber()*e.toNumber(),this.unsigned);var i=this.high>>>16,s=this.high&65535,r=this.low>>>16,o=this.low&65535,a=e.high>>>16,c=e.high&65535,l=e.low>>>16,u=e.low&65535,h=0,f=0,p=0,g=0;return g+=o*u,p+=g>>>16,g&=65535,p+=r*u,f+=p>>>16,p&=65535,p+=o*l,f+=p>>>16,p&=65535,f+=s*u,h+=f>>>16,f&=65535,f+=r*l,h+=f>>>16,f&=65535,f+=o*c,h+=f>>>16,f&=65535,h+=i*u+s*l+r*c+o*a,h&=65535,C(p<<16|g,h<<16|f,this.unsigned)};m.mul=m.multiply;m.divide=function(e){if(U(e)||(e=Z(e)),e.isZero())throw Error("division by zero");if(j){if(!this.unsigned&&this.high===-2147483648&&e.low===-1&&e.high===-1)return this;var t=(this.unsigned?j.div_u:j.div_s)(this.low,this.high,e.low,e.high);return C(t,j.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?re:Y;var i,s,r;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return re;if(e.gt(this.shru(1)))return yi;r=re}else{if(this.eq(q)){if(e.eq(_e)||e.eq(Lt))return q;if(e.eq(q))return _e;var o=this.shr(1);return i=o.div(e).shl(1),i.eq(Y)?e.isNegative()?_e:Lt:(s=this.sub(e.mul(i)),r=i.add(s.div(e)),r)}else if(e.eq(q))return this.unsigned?re:Y;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();r=Y}for(s=this;s.gte(e);){i=Math.max(1,Math.floor(s.toNumber()/e.toNumber()));for(var a=Math.ceil(Math.log(i)/Math.LN2),c=a<=48?1:Ke(2,a-48),l=W(i),u=l.mul(e);u.isNegative()||u.gt(s);)i-=c,l=W(i,this.unsigned),u=l.mul(e);l.isZero()&&(l=_e),r=r.add(l),s=s.sub(u)}return r};m.div=m.divide;m.modulo=function(e){if(U(e)||(e=Z(e)),j){var t=(this.unsigned?j.rem_u:j.rem_s)(this.low,this.high,e.low,e.high);return C(t,j.get_high(),this.unsigned)}return this.sub(this.div(e).mul(e))};m.mod=m.modulo;m.rem=m.modulo;m.not=function(){return C(~this.low,~this.high,this.unsigned)};m.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32};m.clz=m.countLeadingZeros;m.countTrailingZeros=function(){return this.low?vn(this.low):vn(this.high)+32};m.ctz=m.countTrailingZeros;m.and=function(e){return U(e)||(e=Z(e)),C(this.low&e.low,this.high&e.high,this.unsigned)};m.or=function(e){return U(e)||(e=Z(e)),C(this.low|e.low,this.high|e.high,this.unsigned)};m.xor=function(e){return U(e)||(e=Z(e)),C(this.low^e.low,this.high^e.high,this.unsigned)};m.shiftLeft=function(e){return U(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?C(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):C(0,this.low<<e-32,this.unsigned)};m.shl=m.shiftLeft;m.shiftRight=function(e){return U(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?C(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):C(this.high>>e-32,this.high>=0?0:-1,this.unsigned)};m.shr=m.shiftRight;m.shiftRightUnsigned=function(e){return U(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?C(this.low>>>e|this.high<<32-e,this.high>>>e,this.unsigned):e===32?C(this.high,0,this.unsigned):C(this.high>>>e-32,0,this.unsigned)};m.shru=m.shiftRightUnsigned;m.shr_u=m.shiftRightUnsigned;m.rotateLeft=function(e){var t;return U(e)&&(e=e.toInt()),(e&=63)===0?this:e===32?C(this.high,this.low,this.unsigned):e<32?(t=32-e,C(this.low<<e|this.high>>>t,this.high<<e|this.low>>>t,this.unsigned)):(e-=32,t=32-e,C(this.high<<e|this.low>>>t,this.low<<e|this.high>>>t,this.unsigned))};m.rotl=m.rotateLeft;m.rotateRight=function(e){var t;return U(e)&&(e=e.toInt()),(e&=63)===0?this:e===32?C(this.high,this.low,this.unsigned):e<32?(t=32-e,C(this.high<<t|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned)):(e-=32,t=32-e,C(this.low<<t|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned))};m.rotr=m.rotateRight;m.toSigned=function(){return this.unsigned?C(this.low,this.high,!1):this};m.toUnsigned=function(){return this.unsigned?this:C(this.low,this.high,!0)};m.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()};m.toBytesLE=function(){var e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]};m.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,e&255,t>>>24,t>>>16&255,t>>>8&255,t&255]};E.fromBytes=function(e,t,i){return i?E.fromBytesLE(e,t):E.fromBytesBE(e,t)};E.fromBytesLE=function(e,t){return new E(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)};E.fromBytesBE=function(e,t){return new E(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)};typeof BigInt=="function"&&(E.fromBigInt=function(e,t){var i=Number(BigInt.asIntN(32,e)),s=Number(BigInt.asIntN(32,e>>BigInt(32)));return C(i,s,t)},E.fromValue=function(e,t){return typeof e=="bigint"?E.fromBigInt(e,t):Z(e,t)},m.toBigInt=function(){var e=BigInt(this.low>>>0),t=BigInt(this.unsigned?this.high>>>0:this.high);return t<<BigInt(32)|e});const qo=16;function wi(n){n==="X"&&(n="");const e=n.padEnd(qo,"0");return E.fromString(e,!0,16)}function zo(n){if(n.isZero())return"X";let e=n.countTrailingZeros();const t=e%4;e=(e-t)/4;const i=e;e*=4;const r=n.shiftRightUnsigned(e).toString(16).replace(/0+$/,"");return Array(17-i-r.length).join("0")+r}function Fo(n,e){const t=Go(n).shiftRightUnsigned(2);return n.add(E.fromNumber(2*e+1-4).multiply(t))}function Go(n){return n.and(n.not().add(1))}const ko=3,Ho=30,jo=2*Ho+1,Rn=180/Math.PI;function Wo(n){if(n.length===0)throw new Error(`Invalid Hilbert quad key ${n}`);const e=n.split("/"),t=parseInt(e[0],10),i=e[1],s=i.length;let r=0;const o=[0,0];for(let a=s-1;a>=0;a--){r=s-a;const c=i[a];let l=0,u=0;c==="1"?u=1:c==="2"?(l=1,u=1):c==="3"&&(l=1);const h=Math.pow(2,r-1);$o(h,o,l,u),o[0]+=h*l,o[1]+=h*u}if(t%2===1){const a=o[0];o[0]=o[1],o[1]=a}return{face:t,ij:o,level:r}}function Zo(n){if(n.isZero())return"";let e=n.toString(2);for(;e.length<ko+jo;)e="0"+e;const t=e.lastIndexOf("1"),i=e.substring(0,3),s=e.substring(3,t),r=s.length/2,o=E.fromString(i,!0,2).toString(10);let a="";if(r!==0)for(a=E.fromString(s,!0,2).toString(4);a.length<r;)a="0"+a;return`${o}/${a}`}function Ci(n,e,t){const i=1<<e;return[(n[0]+t[0])/i,(n[1]+t[1])/i]}function On(n){return n>=.5?1/3*(4*n*n-1):1/3*(1-4*(1-n)*(1-n))}function Ei(n){return[On(n[0]),On(n[1])]}function bi(n,[e,t]){switch(n){case 0:return[1,e,t];case 1:return[-e,1,t];case 2:return[-e,-t,1];case 3:return[-1,-t,-e];case 4:return[t,-1,-e];case 5:return[t,e,-1];default:throw new Error("Invalid face")}}function Si([n,e,t]){const i=Math.atan2(t,Math.sqrt(n*n+e*e));return[Math.atan2(e,n)*Rn,i*Rn]}function $o(n,e,t,i){if(i===0){t===1&&(e[0]=n-1-e[0],e[1]=n-1-e[1]);const s=e[0];e[0]=e[1],e[1]=s}}function Yo(n){const e=Ci(n.ij,n.level,[.5,.5]),t=Ei(e),i=bi(n.face,t);return Si(i)}const Xo=100;function Dn(n){const{face:e,ij:t,level:i}=n,s=[[0,0],[0,1],[1,1],[1,0],[0,0]],r=Math.max(1,Math.ceil(Xo*Math.pow(2,-i))),o=new Float64Array(4*r*2+2);let a=0,c=0;for(let l=0;l<4;l++){const u=s[l].slice(0),h=s[l+1],f=(h[0]-u[0])/r,p=(h[1]-u[1])/r;for(let g=0;g<r;g++){u[0]+=f,u[1]+=p;const y=Ci(t,i,u),T=Ei(y),_=bi(e,T),b=Si(_);Math.abs(b[1])>89.999&&(b[0]=c);const v=b[0]-c;b[0]+=v>180?-360:v<-180?360:0,o[a++]=b[0],o[a++]=b[1],c=b[0]}}return o[a++]=o[0],o[a++]=o[1],o}function Bt(n){const e=Qo(n);return Wo(e)}function Qo(n){if(n.indexOf("/")>0)return n;const e=wi(n);return Zo(e)}function Ko(n){const e=Bt(n);return Yo(e)}function Jo(n){let e;if(n.face===2||n.face===5){let t=null,i=0;for(let s=0;s<4;s++){const r=`${n.face}/${s}`,o=Bt(r),a=Dn(o);(typeof t>"u"||t===null)&&(t=new Float64Array(4*a.length)),t.set(a,i),i+=a.length}e=Un(t)}else{const t=Dn(n);e=Un(t)}return e}function Un(n){if(n.length%2!==0)throw new Error("Invalid corners");const e=[],t=[];for(let i=0;i<n.length;i+=2)e.push(n[i]),t.push(n[i+1]);return e.sort((i,s)=>i-s),t.sort((i,s)=>i-s),{west:e[0],east:e[e.length-1],north:t[t.length-1],south:t[0]}}function ea(n,e){const t=e?.minimumHeight||0,i=e?.maximumHeight||0,s=Bt(n),r=Jo(s),o=r.west,a=r.south,c=r.east,l=r.north,u=[];return u.push(new d(o,l,t)),u.push(new d(c,l,t)),u.push(new d(c,a,t)),u.push(new d(o,a,t)),u.push(new d(o,l,i)),u.push(new d(c,l,i)),u.push(new d(c,a,i)),u.push(new d(o,a,i)),u}function Li(n){const e=n.token,t={minimumHeight:n.minimumHeight,maximumHeight:n.maximumHeight},i=ea(e,t),s=Ko(e),r=s[0],o=s[1],a=S.WGS84.cartographicToCartesian([r,o,t.maximumHeight]),c=new d(a[0],a[1],a[2]);i.push(c);const l=Gs(i);return[...l.center,...l.halfAxes]}const ta=4,na=8,ia={QUADTREE:ta,OCTREE:na};function sa(n,e,t){if(n?.box){const i=wi(n.s2VolumeInfo.token),s=Fo(i,e),r=zo(s),o={...n.s2VolumeInfo};switch(o.token=r,t){case"OCTREE":const l=n.s2VolumeInfo,u=l.maximumHeight-l.minimumHeight,h=u/2,f=l.minimumHeight+u/2;l.minimumHeight=f-h,l.maximumHeight=f+h;break}return{box:Li(o),s2VolumeInfo:o}}}async function Mi(n){const{subtree:e,subtreeData:t={level:0,x:0,y:0,z:0},parentData:i={mortonIndex:0,localLevel:-1,localX:0,localY:0,localZ:0},childIndex:s=0,implicitOptions:r,loaderOptions:o,s2VolumeBox:a}=n,{subdivisionScheme:c,subtreeLevels:l,maximumLevel:u,contentUrlTemplate:h,subtreesUriTemplate:f,basePath:p}=r,g={children:[],lodMetricValue:0,contentUrl:""};if(!u)return Xn.once(`Missing 'maximumLevel' or 'availableLevels' property. The subtree ${h} won't be loaded...`),g;const y=i.localLevel+1,T=t.level+y;if(T>u)return g;const _=ia[c],b=Math.log2(_),v=s&1,P=s>>1&1,R=s>>2&1,x=de(i.localX,v,1),G=de(i.localY,P,1),k=de(i.localZ,R,1),L=de(t.x,x,y),M=de(t.y,G,y),oe=de(t.z,k,y),pe=de(i.mortonIndex,s,b),De=y===l&&yt(e.childSubtreeAvailability,pe);let ae,Le,Me,me;if(De){const ce=`${p}/${f}`,Ue=Mt(ce,T,L,M,oe);ae=await Pe(Ue,mi,o),me=0,Le={level:T,x:L,y:M,z:oe},Me={mortonIndex:0,localLevel:0,localX:0,localY:0,localZ:0}}else ae=e,me=(_**y-1)/(_-1)+pe,Le=t,Me={mortonIndex:pe,localLevel:y,localX:x,localY:G,localZ:k};if(!yt(ae.tileAvailability,me))return g;yt(ae.contentAvailability,me)&&(g.contentUrl=Mt(h,T,L,M,oe));for(let ce=0;ce<_;ce++){const Ue=sa(a,ce,c),Ve=await Mi({subtree:ae,subtreeData:Le,parentData:Me,childIndex:ce,implicitOptions:r,loaderOptions:o,s2VolumeBox:Ue});(Ve.contentUrl||Ve.children.length)&&g.children.push(Ve)}return g.contentUrl||g.children.length?ra(g,{level:T,x:L,y:M,z:oe},r,a):g}function yt(n,e){let t;return Array.isArray(n)?(t=n[0],n.length>1&&Xn.once('Not supported extension "3DTILES_multiple_contents" has been detected')):t=n,"constant"in t?!!t.constant:t.explicitBitstream?ca(e,t.explicitBitstream):!1}function ra(n,e,t,i){const{basePath:s,refine:r,getRefine:o,lodMetricType:a,getTileType:c,rootLodMetricValue:l,rootBoundingVolume:u}=t,h=n.contentUrl&&n.contentUrl.replace(`${s}/`,""),f=l/2**e.level,p=i?.box?{box:i.box}:u,g=oa(p,e,t.subdivisionScheme);return{children:n.children,contentUrl:n.contentUrl,content:{uri:h},id:n.contentUrl,refine:o(r),type:c(n),lodMetricType:a,lodMetricValue:f,geometricError:f,transform:n.transform,boundingVolume:g}}function oa(n,e,t){if(n.region){const{level:i,x:s,y:r,z:o}=e,[a,c,l,u,h,f]=n.region,p=2**i,g=(l-a)/p,[y,T]=[a+g*s,a+g*(s+1)],_=(u-c)/p,[b,v]=[c+_*r,c+_*(r+1)];let P,R;if(t==="OCTREE"){const x=(f-h)/p;[P,R]=[h+x*o,h+x*(o+1)]}else[P,R]=[h,f];return{region:[y,b,T,v,P,R]}}if(n.box)return n;throw new Error(`Unsupported bounding volume type ${JSON.stringify(n)}`)}function de(n,e,t){return(n<<t)+e}function Mt(n,e,t,i,s){const r=aa({level:e,x:t,y:i,z:s});return n.replace(/{level}|{x}|{y}|{z}/gi,o=>r[o])}function aa(n){const e={};for(const t in n)e[`{${t}}`]=n[t];return e}function ca(n,e){const t=Math.floor(n/8),i=n%8;return(e[t]>>i&1)===1}function qt(n,e=""){if(!e)return se.EMPTY;const i=e.split("?")[0].split(".").pop();switch(i){case"pnts":return se.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return se.SCENEGRAPH;default:return i||se.EMPTY}}function zt(n){switch(n){case"REPLACE":case"replace":return X.REPLACE;case"ADD":case"add":return X.ADD;default:return n}}function vt(n,e){if(/^[a-z][0-9a-z+.-]*:/i.test(e)){const i=new URL(n,`${e}/`);return decodeURI(i.toString())}else if(n.startsWith("/"))return n;return Zi(e,n)}function Vn(n,e){if(!n)return null;let t;if(n.content){const s=n.content.uri||n.content?.url;typeof s<"u"&&(t=vt(s,e))}return{...n,id:t,contentUrl:t,lodMetricType:be.GEOMETRIC_ERROR,lodMetricValue:n.geometricError,transformMatrix:n.transform,type:qt(n,t),refine:zt(n.refine)}}async function la(n,e,t){let i=null;const s=qn(n.root);s&&n.root?i=await Bn(n.root,n,e,s,t):i=Vn(n.root,e);const r=[];for(r.push(i);r.length>0;){const o=r.pop()||{},a=o.children||[],c=[];for(const l of a){const u=qn(l);let h;u?h=await Bn(l,n,e,u,t):h=Vn(l,e),h&&(c.push(h),r.push(h))}o.children=c}return i}async function Bn(n,e,t,i,s){const{subdivisionScheme:r,maximumLevel:o,availableLevels:a,subtreeLevels:c,subtrees:{uri:l}}=i,u=Mt(l,0,0,0,0),h=vt(u,t),f=await Pe(h,mi,s),p=n.content?.uri,g=p?vt(p,t):"",y=e?.root?.refine,T=n.geometricError,_=n.boundingVolume.extensions?.["3DTILES_bounding_volume_S2"];if(_){const R={box:Li(_),s2VolumeInfo:_};n.boundingVolume=R}const b=n.boundingVolume,v={contentUrlTemplate:g,subtreesUriTemplate:l,subdivisionScheme:r,subtreeLevels:c,maximumLevel:Number.isFinite(a)?a-1:o,refine:y,basePath:t,lodMetricType:be.GEOMETRIC_ERROR,rootLodMetricValue:T,rootBoundingVolume:b,getTileType:qt,getRefine:zt};return await ua(n,t,f,v,s)}async function ua(n,e,t,i,s){if(!n)return null;const{children:r,contentUrl:o}=await Mi({subtree:t,implicitOptions:i,loaderOptions:s});let a,c=null;return o&&(a=o,c={uri:o.replace(`${e}/`,"")}),{...n,id:a,contentUrl:a,lodMetricType:be.GEOMETRIC_ERROR,lodMetricValue:n.geometricError,transformMatrix:n.transform,type:qt(n,a),refine:zt(n.refine),content:c||n.content,children:r}}function qn(n){return n?.extensions?.["3DTILES_implicit_tiling"]||n?.implicitTiling}const vi={dataType:null,batchType:null,id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:ai,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:ha,options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};async function ha(n,e={},t){const i=e["3d-tiles"]||{};let s;return i.isTileset==="auto"?s=t?.url&&t.url.indexOf(".json")!==-1:s=i.isTileset,s?da(n,e,t):fa(n,e,t)}async function da(n,e,t){const i=JSON.parse(new TextDecoder().decode(n)),s=t?.url||"",r=pa(s),o=await la(i,r,e||{});return{...i,shape:"tileset3d",loader:vi,url:s,queryString:t?.queryString||"",basePath:r,root:o||i.root,type:B.TILES3D,lodMetricType:be.GEOMETRIC_ERROR,lodMetricValue:i.root?.geometricError||0}}async function fa(n,e,t){const i={content:{shape:"tile3d",featureIds:null}};return await pi(n,0,e,t,i.content),i.content}function pa(n){return Wn(n)}const zn=[0],ma={getPointColor:{type:"accessor",value:[0,0,0,255]},pointSize:1,data:"",loader:vi,onTilesetLoad:{type:"function",value:n=>{}},onTileLoad:{type:"function",value:n=>{}},onTileUnload:{type:"function",value:n=>{}},onTileError:{type:"function",value:(n,e,t)=>{}},_getMeshColor:{type:"function",value:n=>[255,255,255]}};class Ft extends os{initializeState(){"onTileLoadFail"in this.props&&jn.removed("onTileLoadFail","onTileError")(),this.state={layerMap:{},tileset3d:null,activeViewports:{},lastUpdatedViewports:null}}get isLoaded(){return!!(this.state?.tileset3d?.isLoaded()&&super.isLoaded)}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({props:e,oldProps:t,changeFlags:i}){if(e.data&&e.data!==t.data&&this._loadTileset(e.data),i.viewportChanged){const{activeViewports:s}=this.state;Object.keys(s).length&&(this._updateTileset(s),this.state.lastUpdatedViewports=s,this.state.activeViewports={})}if(i.propsChanged){const{layerMap:s}=this.state;for(const r in s)s[r].needsUpdate=!0}}activateViewport(e){const{activeViewports:t,lastUpdatedViewports:i}=this.state;this.internalState.viewport=e,t[e.id]=e;const s=i?.[e.id];(!s||!e.equals(s))&&(this.setChangeFlags({viewportChanged:!0}),this.setNeedsUpdate())}getPickingInfo({info:e,sourceLayer:t}){const i=t&&t.props.tile;return e.picked&&(e.object=i),e.sourceTile=i,e}filterSubLayer({layer:e,viewport:t}){const{tile:i}=e.props,{id:s}=t;return i.selected&&i.viewportIds.includes(s)}_updateAutoHighlight(e){const t=e.sourceTile,i=this.state.layerMap[t?.id];i&&i.layer&&i.layer.updateAutoHighlight(e)}async _loadTileset(e){const{loadOptions:t={}}=this.props,i=this.props.loader||this.props.loaders,s=Array.isArray(i)?i[0]:i,r={loadOptions:{...t}};let o=e;if(s.preload){const l=await s.preload(e,t);l.url&&(o=l.url),l.headers&&(r.loadOptions.fetch={...r.loadOptions.fetch,headers:l.headers}),Object.assign(r,l)}const a=await Pe(o,s,r.loadOptions),c=new $r(a,{onTileLoad:this._onTileLoad.bind(this),onTileUnload:this._onTileUnload.bind(this),onTileError:this.props.onTileError,...r});this.setState({tileset3d:c,layerMap:{}}),this._updateTileset(this.state.activeViewports),this.props.onTilesetLoad(c)}_onTileLoad(e){const{lastUpdatedViewports:t}=this.state;this.props.onTileLoad(e),this._updateTileset(t),this.setNeedsUpdate()}_onTileUnload(e){delete this.state.layerMap[e.id],this.props.onTileUnload(e)}_updateTileset(e){if(!e)return;const{tileset3d:t}=this.state,{timeline:i}=this.context,s=Object.keys(e).length;!i||!s||!t||t.selectTiles(Object.values(e)).then(r=>{this.state.frameNumber!==r&&this.setState({frameNumber:r})})}_getSubLayer(e,t){if(!e.content)return null;switch(e.type){case se.POINTCLOUD:return this._makePointCloudLayer(e,t);case se.SCENEGRAPH:return this._make3DModelLayer(e);case se.MESH:return this._makeSimpleMeshLayer(e,t);default:throw new Error(`Tile3DLayer: Failed to render layer of type ${e.content.type}`)}}_makePointCloudLayer(e,t){const{attributes:i,pointCount:s,constantRGBA:r,cartographicOrigin:o,modelMatrix:a}=e.content,{positions:c,normals:l,colors:u}=i;if(!c)return null;const h=t&&t.props.data||{header:{vertexCount:s},attributes:{POSITION:c,NORMAL:l,COLOR_0:u}},{pointSize:f,getPointColor:p}=this.props,g=this.getSubLayerClass("pointcloud",Nt);return new g({pointSize:f},this.getSubLayerProps({id:"pointcloud"}),{id:`${this.id}-pointcloud-${e.id}`,tile:e,data:h,coordinateSystem:it.METER_OFFSETS,coordinateOrigin:o,modelMatrix:a,getColor:r||p,_offset:0})}_make3DModelLayer(e){const{gltf:t,instances:i,cartographicOrigin:s,modelMatrix:r}=e.content,o=this.getSubLayerClass("scenegraph",ss);return new o({_lighting:"pbr"},this.getSubLayerProps({id:"scenegraph"}),{id:`${this.id}-scenegraph-${e.id}`,tile:e,data:i||zn,scenegraph:t,coordinateSystem:it.METER_OFFSETS,coordinateOrigin:s,modelMatrix:r,getTransformMatrix:a=>a.modelMatrix,getPosition:[0,0,0],_offset:0})}_makeSimpleMeshLayer(e,t){const i=e.content,{attributes:s,indices:r,modelMatrix:o,cartographicOrigin:a,coordinateSystem:c=it.METER_OFFSETS,material:l,featureIds:u}=i,{_getMeshColor:h}=this.props,f=t&&t.props.mesh||new Ne({topology:"triangle-list",attributes:ga(s),indices:r}),p=this.getSubLayerClass("mesh",Rt);return new p(this.getSubLayerProps({id:"mesh"}),{id:`${this.id}-mesh-${e.id}`,tile:e,mesh:f,data:zn,getColor:h(e),pbrMaterial:l,modelMatrix:o,coordinateOrigin:a,coordinateSystem:c,featureIds:u,_offset:0})}renderLayers(){const{tileset3d:e,layerMap:t}=this.state;return e?e.tiles.map(i=>{const s=t[i.id]=t[i.id]||{tile:i};let{layer:r}=s;return i.selected&&(r?s.needsUpdate&&(r=this._getSubLayer(i,r),s.needsUpdate=!1):r=this._getSubLayer(i)),s.layer=r,r}).filter(Boolean):null}}Ft.defaultProps=ma;Ft.layerName="Tile3DLayer";function ga(n){const e={};return e.positions={...n.positions,value:new Float32Array(n.positions.value)},n.normals&&(e.normals=n.normals),n.texCoords&&(e.texCoords=n.texCoords),n.colors&&(e.colors=n.colors),n.uvRegions&&(e.uvRegions=n.uvRegions),e}const Je=n=>{const{mapId:e,...t}=n,i=$i({mapId:e}),s=Yi(),r=kt.useMemo(()=>t.data?new Ft({...t}):null,[t.data,t.id,t.pickable,t.onTileLoad,t.onTileUnload,t.loadOptions,t.loaders,t.visible,t.opacity,t.pointSize,t.beforeId]);return kt.useEffect(()=>{if(!(!i.map||!r))return s.addLayer(r),()=>{r&&s.removeLayer(r)}},[i.map,r]),Tt.jsx(Tt.Fragment,{})};try{Je.displayName="Ml3DTileLayer",Je.__docgenInfo={description:"",displayName:"Ml3DTileLayer",props:{mapId:{defaultValue:null,description:"Id of the target MapLibre instance in mapContext",name:"mapId",required:!1,type:{name:"string | undefined"}},beforeId:{defaultValue:null,description:`Id of an existing layer in the mapLibre instance to help specify the layer order
This layer will be visually beneath the layer with the "beforeId" id.`,name:"beforeId",required:!1,type:{name:"string | undefined"}},data:{defaultValue:null,description:"The data to visualize.",name:"data",required:!1,type:{name:"string"}},getPointColor:{defaultValue:null,description:"Color Accessor for point clouds. *",name:"getPointColor",required:!1,type:{name:"Accessor<unknown, Color> | undefined"}},pointSize:{defaultValue:null,description:"Global radius of all points in pixels. *",name:"pointSize",required:!1,type:{name:"number | undefined"}},loader:{defaultValue:null,description:"A loader which is used to decode the fetched tiles.\n@deprecated Use `loaders` instead",name:"loader",required:!1,type:{name:'{ readonly dataType: any; readonly batchType: never; readonly id: "3d-tiles"; readonly name: "3D Tiles"; readonly module: "3d-tiles"; readonly version: any; readonly extensions: ["cmpt", "pnts", "b3dm", "i3dm"]; readonly mimeTypes: [...]; readonly tests: [...]; readonly parse: (data: any, options?: Tiles3DLoaderOpti...'}},onTilesetLoad:{defaultValue:null,description:"Called when Tileset JSON file is loaded. *",name:"onTilesetLoad",required:!1,type:{name:"((tile: Tileset3D) => void) | undefined"}},onTileLoad:{defaultValue:null,description:"Called when a tile in the tileset hierarchy is loaded. *",name:"onTileLoad",required:!1,type:{name:"((tile: Tile3D) => void) | undefined"}},onTileUnload:{defaultValue:null,description:"Called when a tile is unloaded. *",name:"onTileUnload",required:!1,type:{name:"((tile: Tile3D) => void) | undefined"}},onTileError:{defaultValue:null,description:"Called when a tile fails to load. *",name:"onTileError",required:!1,type:{name:"((tile: Tile3D, url: string, message: string) => void) | undefined"}},_getMeshColor:{defaultValue:null,description:"(Experimental) Accessor to change color of mesh based on properties. *",name:"_getMeshColor",required:!1,type:{name:"((tile: Tile3D) => Color) | undefined"}},id:{defaultValue:null,description:"Unique identifier of the layer.",name:"id",required:!0,type:{name:"string"}},dataComparator:{defaultValue:null,description:"Callback to determine if two data values are equal.",name:"dataComparator",required:!1,type:{name:"(<LayerDataT = LayerData<unknown>>(newData: LayerDataT, oldData?: LayerDataT | undefined) => boolean) | null | undefined"}},_dataDiff:{defaultValue:null,description:"Callback to determine the difference between two data values, in order to perform a partial update.",name:"_dataDiff",required:!1,type:{name:"(<LayerDataT = LayerData<unknown>>(newData: LayerDataT, oldData?: LayerDataT | undefined) => { startRow: number; endRow?: number | undefined; }[]) | null | undefined"}},dataTransform:{defaultValue:null,description:"Callback to manipulate remote data when it's fetched and parsed.",name:"dataTransform",required:!1,type:{name:"(<LayerDataT = LayerData<unknown>>(data: unknown, previousData?: LayerDataT | undefined) => LayerDataT) | null | undefined"}},fetch:{defaultValue:null,description:"Custom implementation to fetch and parse content from URLs.",name:"fetch",required:!1,type:{name:"((url: string, context: { propName: string; layer: Layer<{}>; loaders?: Loader[] | undefined; loadOptions?: any; signal?: AbortSignal | undefined; }) => any) | undefined"}},updateTriggers:{defaultValue:null,description:"The dependencies used to trigger re-evaluation of functional accessors (get*).",name:"updateTriggers",required:!1,type:{name:"Record<string, any> | undefined"}},operation:{defaultValue:null,description:"Rendering operation of the layer. `+` separated list of names.",name:"operation",required:!1,type:{name:"enum",value:[{value:"undefined"},{value:'"draw"'},{value:'"mask"'},{value:'"terrain"'},{value:'"draw+draw"'},{value:'"draw+mask"'},{value:'"draw+terrain"'},{value:'"mask+draw"'},{value:'"mask+mask"'},{value:'"mask+terrain"'},{value:'"terrain+draw"'},{value:'"terrain+mask"'},{value:'"terrain+terrain"'}]}},visible:{defaultValue:null,description:"If the layer should be rendered. Default true.",name:"visible",required:!1,type:{name:"boolean | undefined"}},pickable:{defaultValue:null,description:"If the layer can be picked on pointer events. Default false.",name:"pickable",required:!1,type:{name:"boolean | undefined"}},opacity:{defaultValue:null,description:"Opacity of the layer, between 0 and 1. Default 1.",name:"opacity",required:!1,type:{name:"number | undefined"}},coordinateSystem:{defaultValue:null,description:"The coordinate system of the data. Default to COORDINATE_SYSTEM.LNGLAT in a geospatial view or COORDINATE_SYSTEM.CARTESIAN in a non-geospatial view.",name:"coordinateSystem",required:!1,type:{name:"enum",value:[{value:"undefined"},{value:"0"},{value:"3"},{value:"1"},{value:"-1"},{value:"2"}]}},coordinateOrigin:{defaultValue:null,description:"The coordinate origin of the data.",name:"coordinateOrigin",required:!1,type:{name:"[number, number, number] | undefined"}},modelMatrix:{defaultValue:null,description:"A 4x4 matrix to transform local coordianates to the world space.",name:"modelMatrix",required:!1,type:{name:"Matrix4Like | null | undefined"}},wrapLongitude:{defaultValue:null,description:"(Geospatial only) normalize geometries that cross the 180th meridian. Default false.",name:"wrapLongitude",required:!1,type:{name:"boolean | undefined"}},positionFormat:{defaultValue:null,description:"The format of positions, default 'XYZ'.",name:"positionFormat",required:!1,type:{name:"enum",value:[{value:"undefined"},{value:'"XYZ"'},{value:'"XY"'}]}},colorFormat:{defaultValue:null,description:"The format of colors, default 'RGBA'.",name:"colorFormat",required:!1,type:{name:"enum",value:[{value:"undefined"},{value:'"RGBA"'},{value:'"RGB"'}]}},parameters:{defaultValue:null,description:"Override the WebGL parameters used to draw this layer. See https://luma.gl/modules/gltools/docs/api-reference/parameter-setting#parameters",name:"parameters",required:!1,type:{name:"Parameters | undefined"}},transitions:{defaultValue:null,description:"Create smooth transitions when prop values update.",name:"transitions",required:!1,type:{name:"Record<string, any> | null | undefined"}},extensions:{defaultValue:null,description:"Add additional functionalities to this layer.",name:"extensions",required:!1,type:{name:"LayerExtension<unknown>[] | undefined"}},loaders:{defaultValue:null,description:"Add support for additional data formats.",name:"loaders",required:!1,type:{name:"Loader[] | undefined"}},loadOptions:{defaultValue:null,description:"Options to customize the behavior of loaders",name:"loadOptions",required:!1,type:{name:"any"}},getPolygonOffset:{defaultValue:null,description:"Callback to calculate the polygonOffset WebGL parameter.",name:"getPolygonOffset",required:!1,type:{name:"((params: { layerIndex: number; }) => [number, number]) | null | undefined"}},autoHighlight:{defaultValue:null,description:"Enable GPU-based object highlighting. Default false.",name:"autoHighlight",required:!1,type:{name:"boolean | undefined"}},highlightedObjectIndex:{defaultValue:null,description:"The index of the data object to highlight. If unspecified, the currently hoverred object is highlighted.",name:"highlightedObjectIndex",required:!1,type:{name:"number | null | undefined"}},highlightColor:{defaultValue:null,description:"The color of the highlight.",name:"highlightColor",required:!1,type:{name:"number[] | ((pickingInfo: { color: Uint8Array<ArrayBufferLike> | null; layer: Layer<{}> | null; sourceLayer?: Layer<{}> | null | undefined; viewport?: Viewport | undefined; ... 8 more ...; pixelRatio: number; }) => number[]) | undefined"}},onDataLoad:{defaultValue:null,description:"Called when remote data is fetched and parsed.",name:"onDataLoad",required:!1,type:{name:"(<LayerDataT = LayerData<unknown>>(data: LayerDataT, context: { propName: string; layer: Layer<{}>; }) => void) | null | undefined"}},onError:{defaultValue:null,description:"Called when the layer encounters an error.",name:"onError",required:!1,type:{name:"((error: Error) => boolean | void) | null | undefined"}},onHover:{defaultValue:null,description:"Called when the mouse enters/leaves an object of this layer.",name:"onHover",required:!1,type:{name:"((pickingInfo: { color: Uint8Array<ArrayBufferLike> | null; layer: Layer<{}> | null; sourceLayer?: Layer<{}> | null | undefined; viewport?: Viewport | undefined; ... 8 more ...; pixelRatio: number; }, event: MjolnirEvent) => boolean | void) | null | undefined"}},onClick:{defaultValue:null,description:"Called when the mouse clicks over an object of this layer.",name:"onClick",required:!1,type:{name:"((pickingInfo: { color: Uint8Array<ArrayBufferLike> | null; layer: Layer<{}> | null; sourceLayer?: Layer<{}> | null | undefined; viewport?: Viewport | undefined; ... 8 more ...; pixelRatio: number; }, event: MjolnirEvent) => boolean | void) | null | undefined"}},onDragStart:{defaultValue:null,description:"Called when the mouse starts dragging an object of this layer.",name:"onDragStart",required:!1,type:{name:"((pickingInfo: { color: Uint8Array<ArrayBufferLike> | null; layer: Layer<{}> | null; sourceLayer?: Layer<{}> | null | undefined; viewport?: Viewport | undefined; ... 8 more ...; pixelRatio: number; }, event: MjolnirEvent) => boolean | void) | null | undefined"}},onDrag:{defaultValue:null,description:"Called when the mouse drags an object of this layer.",name:"onDrag",required:!1,type:{name:"((pickingInfo: { color: Uint8Array<ArrayBufferLike> | null; layer: Layer<{}> | null; sourceLayer?: Layer<{}> | null | undefined; viewport?: Viewport | undefined; ... 8 more ...; pixelRatio: number; }, event: MjolnirEvent) => boolean | void) | null | undefined"}},onDragEnd:{defaultValue:null,description:"Called when the mouse releases an object of this layer.",name:"onDragEnd",required:!1,type:{name:"((pickingInfo: { color: Uint8Array<ArrayBufferLike> | null; layer: Layer<{}> | null; sourceLayer?: Layer<{}> | null | undefined; viewport?: Viewport | undefined; ... 8 more ...; pixelRatio: number; }, event: MjolnirEvent) => boolean | void) | null | undefined"}},numInstances:{defaultValue:null,description:"(Advanced) supply attribute size externally",name:"numInstances",required:!1,type:{name:"number | null | undefined"}},startIndices:{defaultValue:null,description:"(Advanced) supply variable-width attribute size externally",name:"startIndices",required:!1,type:{name:"NumericArray | null | undefined"}},_subLayerProps:{defaultValue:null,description:"(Experimental) override sub layer props. Only works on a composite layer.",name:"_subLayerProps",required:!1,type:{name:"{ [subLayerId: string]: { [propName: string]: any; type?: ConstructorOf<Layer<{}>> | undefined; }; } | null | undefined"}}}}}catch{}const Sa={title:"MapComponents/Ml3DTileLayer",component:Je,argTypes:{},decorators:Xi},Ii=n=>Tt.jsx(Je,{...n}),we=Ii.bind({});we.parameters={mapOptions:{center:[7.842650747974176,47.98896351950512],pitch:43.5,zoom:22,bearing:-8.151137833252392}};we.args={mapId:"map_1",id:"PointCould",data:"assets/tiles/tileset.json",pointSize:2};const Ce=Ii.bind({});Ce.parameters={mapOptions:{center:[9.993682,53.551086],pitch:58,zoom:14.788260082345504,bearing:0}};Ce.args={mapId:"map_1",data:"https://3dtiles.wheregroup.com/tileset.json"};we.parameters={...we.parameters,docs:{...we.parameters?.docs,source:{originalSource:`(context: any) => {
  return <Ml3DTileLayer {...context} />;
}`,...we.parameters?.docs?.source}}};Ce.parameters={...Ce.parameters,docs:{...Ce.parameters?.docs,source:{originalSource:`(context: any) => {
  return <Ml3DTileLayer {...context} />;
}`,...Ce.parameters?.docs?.source}}};const La=["PointCloudExample","HamburgExample"];export{Ce as HamburgExample,we as PointCloudExample,La as __namedExportsOrder,Sa as default};
